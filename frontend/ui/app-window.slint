// ============================================================================
// app-window.slint
// ============================================================================
// Main application window component for the rbibli (personal library management) system.
//
// This is the root component of the Slint UI application. It provides:
// - A navigation sidebar for switching between different pages
// - Conditional rendering of pages based on sidebar selection
// - Data properties for storing application state (titles, authors, etc.)
// - Callbacks for communicating with the Rust backend via API calls
//
// The window uses a horizontal layout with:
// - Left side: Navigation sidebar with menu items
// - Right side: Content area showing the currently selected page
//
// Pages are conditionally rendered based on the sidebar's current-item index:
//   0 = Titles Page (manage books/titles)
//   1 = Locations Page (manage storage locations)
//   2 = Authors Page (manage authors)
//   3 = Publishers Page (manage publishers)
//   4 = Genres Page (manage genres/categories)
//   5 = Loans Page (manage book loans) - NOT YET IMPLEMENTED
//   6 = Statistics Page (view library statistics) - NOT YET IMPLEMENTED
//   7 = About Page (application information)
//
// All text is internationalized using the @tr() macro for multi-language support.
// ============================================================================

import { Button, VerticalBox, ScrollView, StyleMetrics } from "std-widgets.slint";
import {SideBar} from "side_bar.slint";
import {AboutPage, TitlesPage, TitleData, GenreItem, PublisherItem, VolumeData, LocationsPage, LocationData, AuthorsPage, AuthorData, PublishersPage, PublisherData, GenresPage, GenreData, LoansPage, LoanData, BorrowerData, BorrowerGroupData} from "pages/pages.slint";
import { Styles } from "styles.slint";

// AppWindow - Main application window component
//
// This component serves as the root container for the entire application.
// It manages the overall application state and coordinates communication between
// the UI and the Rust backend through a series of callbacks.
//
// Properties:
//   - titles: Array of book titles with their metadata and volume counts
//   - locations: Array of physical storage locations with hierarchical paths
//   - authors: Array of authors with their biographical information
//   - publishers: Array of publishers with their company details
//   - genres: Array of book genres/categories
//   - genre-items: Array of genre items formatted for dropdowns
//   - genre-names: Array of genre names for ComboBox widgets
//
// Callbacks (connected to Rust backend):
//   Data Loading:
//     - load-titles(): Fetches all titles from the backend
//     - load-locations(): Fetches all locations from the backend
//     - load-authors(): Fetches all authors from the backend
//     - load-publishers(): Fetches all publishers from the backend
//     - load-genres(): Fetches all genres from the backend
//
//   Title Operations:
//     - create-title(title, subtitle, isbn, publisher, year, pages, lang, genre, summary)
//     - update-title(id, title, subtitle, isbn, publisher, year, pages, lang, genre, summary)
//     - find-genre-index(genre-id) -> int: Finds the index of a genre in the dropdown
//
//   Location Operations:
//     - create-location(name, description, parent-id)
//     - delete-location(id)
//
//   Author Operations:
//     - create-author(first-name, last-name, bio, birth, death, nationality, website)
//     - delete-author(id)
//
//   Publisher Operations:
//     - create-publisher(name, description, website, country, founded-year)
//     - update-publisher(id, name, description, website, country, founded-year)
//     - delete-publisher(id)
//
//   Genre Operations:
//     - create-genre(name, description)
//     - update-genre(id, name, description)
//     - delete-genre(id)
//
// Window Settings:
//   - Minimum size: 700x500 pixels
//   - Title: "Personal Library" (internationalized)
export component AppWindow inherits Window {
    // ========================================================================
    // Data Properties
    // ========================================================================
    // These properties store the application data fetched from the backend.
    // They are updated by the Rust code when data is loaded or modified.

    // Array of titles with volume counts (books in the library)
    in-out property <[TitleData]> titles: [];

    // Array of storage locations with hierarchical paths
    in-out property <[LocationData]> locations: [];

    // Array of location names (full paths) for ComboBox widgets
    in-out property <[string]> location-names: [];

    // Array of authors with biographical information
    in-out property <[AuthorData]> authors: [];

    // Array of publishers with company details
    in-out property <[PublisherData]> publishers: [];

    // Array of publisher items formatted for dropdown selection
    in-out property <[PublisherItem]> publisher-items: [];

    // Array of publisher names for ComboBox widgets
    in-out property <[string]> publisher-names: [];

    // Array of genres with title counts
    in-out property <[GenreData]> genres: [];

    // Array of genre items formatted for dropdown selection
    in-out property <[GenreItem]> genre-items: [];

    // Array of genre names for ComboBox widgets
    in-out property <[string]> genre-names: [];

    // Array of volumes for the currently expanded title
    in-out property <[VolumeData]> volumes: [];

    // ID of the title whose volumes are currently expanded
    in-out property <string> expanded-title-id: "";

    // Expose title form properties for ISBN lookup functionality
    in-out property <string> new-title: "";
    in-out property <string> new-subtitle: "";
    in-out property <string> new-isbn: "";
    in-out property <string> new-publisher: "";
    in-out property <string> new-publication-year: "";
    in-out property <string> new-pages: "";
    in-out property <string> new-language: "fr";
    in-out property <string> new-summary: "";

    in-out property <string> edit-title: "";
    in-out property <string> edit-subtitle: "";
    in-out property <string> edit-isbn: "";
    in-out property <string> edit-publisher: "";
    in-out property <string> edit-publication-year: "";
    in-out property <string> edit-pages: "";
    in-out property <string> edit-language: "";
    in-out property <string> edit-summary: "";

    // ========================================================================
    // Callbacks - Title Operations
    // ========================================================================

    // Triggers loading of all titles from the backend
    callback load-titles();

    // Creates a new title in the library
    // Parameters: title, subtitle, isbn, publisher, publisher-id, publication-year, pages, language, genre-id, summary, cover-url
    callback create-title(string, string, string, string, string, string, string, string, string, string, string);

    // Updates an existing title's information
    // Parameters: id, title, subtitle, isbn, publisher, publisher-id, publication-year, pages, language, genre-id, summary, cover-url
    callback update-title(string, string, string, string, string, string, string, string, string, string, string, string);

    // Deletes a title from the library
    // Parameter: id (UUID string)
    // Note: A title can only be deleted if it has no volumes (volume_count == 0)
    callback delete-title(string);

    // Uploads a cover image for a title
    // Parameter: title-id (UUID string)
    // Opens a file dialog and uploads the selected image to the backend
    callback upload-image(string);

    // Fetches book data from ISBN (Google Books API) for create dialog
    // Parameter: isbn (ISBN-10 or ISBN-13)
    // Directly populates the "new" UI fields with the fetched data
    callback fetch-from-isbn(string);

    // Fetches book data from ISBN (Google Books API) for edit dialog
    // Parameter: isbn (ISBN-10 or ISBN-13)
    // Directly populates the "edit" UI fields with the fetched data
    callback fetch-from-isbn-edit(string);

    // Finds the index of a genre in the genre dropdown list
    // Parameter: genre-id (UUID string)
    // Returns: Index position in the dropdown, or -1 if not found
    callback find-genre-index(string) -> int;

    // Finds the index of a publisher in the publisher dropdown list
    // Parameter: publisher-id (UUID string)
    // Returns: Index position in the dropdown, or -1 if not found
    callback find-publisher-index(string) -> int;

    // ========================================================================
    // Callbacks - Volume Operations
    // ========================================================================

    // Triggers loading of volumes for a specific title
    // Parameter: title-id (UUID string)
    callback load-volumes(string);

    // Creates a new volume for a title
    // Parameters: title-id, barcode, condition, location-id, notes
    callback create-volume(string, string, string, string, string);

    // Updates an existing volume's information
    // Parameters: id, barcode, condition, location-id, notes
    callback update-volume(string, string, string, string, string);

    // Deletes a volume from the library
    // Parameter: id (UUID string)
    // Note: A volume can only be deleted if it is not loaned or overdue
    callback delete-volume(string);

    // ========================================================================
    // Callbacks - Location Operations
    // ========================================================================

    // Triggers loading of all storage locations from the backend
    callback load-locations();

    // Creates a new storage location
    // Parameters: name, description, parent-id (UUID or empty for root location)
    callback create-location(string, string, string);

    // Deletes a storage location by ID
    // Parameter: id (UUID string)
    callback delete-location(string);

    // ========================================================================
    // Callbacks - Author Operations
    // ========================================================================

    // Triggers loading of all authors from the backend
    callback load-authors();

    // Creates a new author
    // Parameters: first-name, last-name, biography, birth-date, death-date, nationality, website-url
    callback create-author(string, string, string, string, string, string, string);

    // Deletes an author by ID
    // Parameter: id (UUID string)
    callback delete-author(string);

    // ========================================================================
    // Callbacks - Publisher Operations
    // ========================================================================

    // Triggers loading of all publishers from the backend
    callback load-publishers();

    // Creates a new publisher
    // Parameters: name, description, website-url, country, founded-year
    callback create-publisher(string, string, string, string, string);

    // Updates an existing publisher's information
    // Parameters: id, name, description, website-url, country, founded-year
    callback update-publisher(string, string, string, string, string, string);

    // Deletes a publisher by ID
    // Parameter: id (UUID string)
    callback delete-publisher(string);

    // ========================================================================
    // Callbacks - Genre Operations
    // ========================================================================

    // Triggers loading of all genres from the backend
    callback load-genres();

    // Creates a new genre/category
    // Parameters: name, description
    callback create-genre(string, string);

    // Updates an existing genre's information
    // Parameters: id, name, description
    callback update-genre(string, string, string);

    // Deletes a genre by ID
    // Parameter: id (UUID string)
    callback delete-genre(string);

    // ========================================================================
    // Data Properties - Loans Management
    // ========================================================================

    // Array of active loans with full details
    in-out property <[LoanData]> active-loans: [];

    // Array of borrowers with group information
    in-out property <[BorrowerData]> borrowers: [];

    // Array of borrower groups with loan policies
    in-out property <[BorrowerGroupData]> borrower-groups: [];

    // Array of borrower names for ComboBox
    in-out property <[string]> borrower-names: [];

    // Array of group names for ComboBox
    in-out property <[string]> group-names: [];

    // ========================================================================
    // Callbacks - Loans Operations
    // ========================================================================

    // Triggers loading of all active loans from the backend
    callback load-active-loans();

    // Creates a new loan by barcode scanning
    // Parameters: borrower-id, barcode
    callback create-loan(string, string);

    // Returns a loaned volume
    // Parameter: loan-id (UUID string)
    callback return-loan(string);

    // ========================================================================
    // Callbacks - Borrowers Operations
    // ========================================================================

    // Triggers loading of all borrowers from the backend
    callback load-borrowers();

    // Creates a new borrower
    // Parameters: name, email, phone, address, city, zip, group-id
    callback create-borrower(string, string, string, string, string, string, string);

    // Updates an existing borrower's information
    // Parameters: id, name, email, phone, address, city, zip, group-id
    callback update-borrower(string, string, string, string, string, string, string, string);

    // Deletes a borrower by ID
    // Parameter: id (UUID string)
    callback delete-borrower(string);

    // ========================================================================
    // Callbacks - Borrower Groups Operations
    // ========================================================================

    // Triggers loading of all borrower groups from the backend
    callback load-borrower-groups();

    // Creates a new borrower group
    // Parameters: name, loan-duration-days, description
    callback create-borrower-group(string, int, string);

    // Updates an existing borrower group's information
    // Parameters: id, name, loan-duration-days, description
    callback update-borrower-group(string, string, int, string);

    // Deletes a borrower group by ID
    // Parameter: id (UUID string)
    callback delete-borrower-group(string);

    // ========================================================================
    // Window Configuration
    // ========================================================================
    // Minimum window dimensions to ensure usable interface
    min-width: Styles.app_horizontal_size;
    min-height: Styles.app_vertical_size;

    // Window title (internationalized)
    title: @tr("Personal Library");

    // Optional: Custom window icon (currently commented out)
    //icon: @image-url("../../logo/slint-logo-small-light.png");

    // ========================================================================
    // Main Layout - Horizontal split between sidebar and content
    // ========================================================================
    HorizontalLayout {
        // Left side: Navigation sidebar
        // The sidebar provides menu items for switching between different pages.
        // The current-item property tracks which menu item is selected (0-7).
        side-bar := SideBar {
            title: @tr("Personal Library");
            // Menu items (internationalized):
            // 0: Titles, 1: Locations, 2: Authors, 3: Publishers,
            // 4: Genres, 5: Loans (TODO), 6: Statistics (TODO), 7: About
            model: [@tr("Menu" => "Titles"), @tr("Menu" => "Locations"), @tr("Menu" => "Authors"), @tr("Menu" => "Publishers"), @tr("Menu" => "Genres"), @tr("Menu" => "Loans"), @tr("Menu" => "Statistics"), @tr("Menu" => "About")];
        }

        // ====================================================================
        // Right side: Content area with conditional page rendering
        // ====================================================================
        // Pages are shown/hidden based on the sidebar's current-item property.
        // Each page receives data and callbacks from the AppWindow.
        // Wrapped in ScrollView to provide scrollbars when content exceeds window size.

        ScrollView {
            // PAGE 0: Titles Page - Manage books and titles in the library
            if(side-bar.current-item == 0) : TitlesPage {
            titles: root.titles;
            genres: root.genre-items;
            genre-names: root.genre-names;
            publishers: root.publisher-items;
            publisher-names: root.publisher-names;
            locations: root.locations;
            location-names: root.location-names;
            volumes <=> root.volumes;
            expanded-title-id <=> root.expanded-title-id;
            // Bind form properties for ISBN lookup
            new-title <=> root.new-title;
            new-subtitle <=> root.new-subtitle;
            new-isbn <=> root.new-isbn;
            new-publisher <=> root.new-publisher;
            new-publication-year <=> root.new-publication-year;
            new-pages <=> root.new-pages;
            new-language <=> root.new-language;
            new-summary <=> root.new-summary;
            edit-title <=> root.edit-title;
            edit-subtitle <=> root.edit-subtitle;
            edit-isbn <=> root.edit-isbn;
            edit-publisher <=> root.edit-publisher;
            edit-publication-year <=> root.edit-publication-year;
            edit-pages <=> root.edit-pages;
            edit-language <=> root.edit-language;
            edit-summary <=> root.edit-summary;
            load-titles => {
                root.load-titles();
            }
            create-title(title, subtitle, isbn, publisher, publisher-id, publication-year, pages, language, genre-id, summary, cover-url) => {
                root.create-title(title, subtitle, isbn, publisher, publisher-id, publication-year, pages, language, genre-id, summary, cover-url);
            }
            update-title(id, title, subtitle, isbn, publisher, publisher-id, publication-year, pages, language, genre-id, summary, cover-url) => {
                root.update-title(id, title, subtitle, isbn, publisher, publisher-id, publication-year, pages, language, genre-id, summary, cover-url);
            }
            delete-title(id) => {
                root.delete-title(id);
            }
            upload-image(title-id) => {
                root.upload-image(title-id);
            }
            fetch-from-isbn(isbn) => {
                root.fetch-from-isbn(isbn);
            }
            fetch-from-isbn-edit(isbn) => {
                root.fetch-from-isbn-edit(isbn);
            }
            find-genre-index(genre-id) => {
                return root.find-genre-index(genre-id);
            }
            find-publisher-index(publisher-id) => {
                return root.find-publisher-index(publisher-id);
            }
            load-volumes(title-id) => {
                root.load-volumes(title-id);
            }
            create-volume(title-id, barcode, condition, location-id, notes) => {
                root.create-volume(title-id, barcode, condition, location-id, notes);
            }
            update-volume(id, barcode, condition, location-id, notes) => {
                root.update-volume(id, barcode, condition, location-id, notes);
            }
            delete-volume(id) => {
                root.delete-volume(id);
            }
        }

        // PAGE 1: Locations Page - Manage physical storage locations
        if(side-bar.current-item == 1) : LocationsPage {
            locations: root.locations;
            load-locations => {
                root.load-locations();
            }
            create-location(name, description, parent-id) => {
                root.create-location(name, description, parent-id);
            }
            delete-location(id) => {
                root.delete-location(id);
            }
        }

        // PAGE 2: Authors Page - Manage book authors
        if(side-bar.current-item == 2) : AuthorsPage {
            authors: root.authors;
            load-authors => {
                root.load-authors();
            }
            create-author(first-name, last-name, biography, birth-date, death-date, nationality, website-url) => {
                root.create-author(first-name, last-name, biography, birth-date, death-date, nationality, website-url);
            }
            delete-author(id) => {
                root.delete-author(id);
            }
        }

        // PAGE 3: Publishers Page - Manage publishing companies
        if(side-bar.current-item == 3) : PublishersPage {
            publishers: root.publishers;
            load-publishers => {
                root.load-publishers();
            }
            create-publisher(name, description, website-url, country, founded-year) => {
                root.create-publisher(name, description, website-url, country, founded-year);
            }
            update-publisher(id, name, description, website-url, country, founded-year) => {
                root.update-publisher(id, name, description, website-url, country, founded-year);
            }
            delete-publisher(id) => {
                root.delete-publisher(id);
            }
        }

        // PAGE 4: Genres Page - Manage book genres/categories
        if(side-bar.current-item == 4) : GenresPage {
            genres: root.genres;
            load-genres => {
                root.load-genres();
            }
            create-genre(name, description) => {
                root.create-genre(name, description);
            }
            update-genre(id, name, description) => {
                root.update-genre(id, name, description);
            }
            delete-genre(id) => {
                root.delete-genre(id);
            }
        }

        // PAGE 5: Loans Page - Manage book loans, borrowers, and groups
        if(side-bar.current-item == 5) : LoansPage {
            active-loans: root.active-loans;
            borrowers: root.borrowers;
            borrower-groups: root.borrower-groups;
            borrower-names: root.borrower-names;
            group-names: root.group-names;

            load-active-loans => {
                root.load-active-loans();
            }
            load-borrowers => {
                root.load-borrowers();
            }
            load-borrower-groups => {
                root.load-borrower-groups();
            }
            create-loan(borrower-id, barcode) => {
                root.create-loan(borrower-id, barcode);
            }
            return-loan(loan-id) => {
                root.return-loan(loan-id);
            }
            create-borrower(name, email, phone, address, city, zip, group-id) => {
                root.create-borrower(name, email, phone, address, city, zip, group-id);
            }
            update-borrower(id, name, email, phone, address, city, zip, group-id) => {
                root.update-borrower(id, name, email, phone, address, city, zip, group-id);
            }
            delete-borrower(id) => {
                root.delete-borrower(id);
            }
            create-borrower-group(name, loan-duration-days, description) => {
                root.create-borrower-group(name, loan-duration-days, description);
            }
            update-borrower-group(id, name, loan-duration-days, description) => {
                root.update-borrower-group(id, name, loan-duration-days, description);
            }
            delete-borrower-group(id) => {
                root.delete-borrower-group(id);
            }
        }

        // PAGE 6: Statistics Page - View library statistics (NOT YET IMPLEMENTED)
        //if(side-bar.current-item == 6) : StatisticsPage {}

        // PAGE 7: About Page - Application information and version
            if(side-bar.current-item == 7) : AboutPage {}
        }
    }
}
