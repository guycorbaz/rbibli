// ============================================================================
// authors_page.slint
// ============================================================================
// Authors management page for the rbibli personal library application.
//
// This page provides a complete interface for managing book authors in the
// library database. It allows users to:
// - View a list of all authors with their biographical information
// - See the number of titles associated with each author
// - Create new authors with full biographical details
// - Delete existing authors (if they have no associated titles)
// - Refresh the author list from the backend
//
// The page uses a card-based layout with alternating row colors for better
// readability. Each author card displays:
// - Full name (first + last name) in bold
// - Title count badge (if author has books)
// - Nationality with emoji indicator
// - Birth and death dates (if available)
// - Biography excerpt
// - Website link (if available)
// - Delete action button
//
// The create dialog provides form fields for all author attributes:
// - First name and last name (required)
// - Biography (multi-line text)
// - Birth date and death date (ISO format: YYYY-MM-DD)
// - Nationality
// - Website URL
//
// All text is internationalized using @tr() for multi-language support.
// ============================================================================

import { Page } from "page.slint";
import { ListView, VerticalBox, HorizontalBox, Button, LineEdit, TextEdit } from "std-widgets.slint";

// AuthorData - Data structure for author information (EXPORTED)
//
// This struct represents a single author with their biographical information
// and statistics. It mirrors the backend API's author data structure.
//
// Fields:
//   - id: Unique identifier (UUID string) for the author
//   - first-name: Author's first/given name
//   - last-name: Author's last/family/surname
//   - biography: Biographical text about the author
//   - birth-date: Birth date in ISO format (YYYY-MM-DD), empty if unknown
//   - death-date: Death date in ISO format (YYYY-MM-DD), empty if alive/unknown
//   - nationality: Author's nationality (e.g., "American", "British")
//   - website-url: Author's website URL
//   - title-count: Number of titles/books associated with this author
//
// Example:
//   AuthorData {
//       id: "123e4567-e89b-12d3-a456-426614174000",
//       first-name: "Isaac",
//       last-name: "Asimov",
//       biography: "American science fiction writer",
//       birth-date: "1920-01-02",
//       death-date: "1992-04-06",
//       nationality: "American",
//       website-url: "",
//       title-count: 42
//   }
export struct AuthorData {
    id: string,
    first-name: string,
    last-name: string,
    biography: string,
    birth-date: string,
    death-date: string,
    nationality: string,
    website-url: string,
    title-count: int,
}

// AuthorsPage - Authors management page component (EXPORTED)
//
// This component provides the complete user interface for managing authors
// in the library. It inherits from the base Page component to maintain
// consistent styling with other pages.
//
// Features:
//   - List view of all authors with biographical details
//   - Create new authors via modal dialog form
//   - Delete authors with confirmation
//   - Empty state message when no authors exist
//   - Alternating row colors for better readability
//   - Title count badges showing number of associated books
//   - Emoji indicators for nationality, dates, and website
//
// Layout Structure:
//   1. Header: Page title with Refresh and New Author buttons
//   2. Create Dialog: Modal form for adding new authors (conditional)
//   3. Empty State: Message when no authors exist (conditional)
//   4. Author List: Card-based list view of all authors (conditional)
//
// Data Flow:
//   - Authors data is passed from AppWindow via the authors property
//   - Create/delete operations trigger callbacks to Rust backend
//   - Backend updates database and returns new data
//   - Authors property is updated, triggering UI refresh
//
// Validation:
//   - First name and last name are required fields
//   - Create button is disabled until both required fields are filled
//   - Date fields accept ISO format (YYYY-MM-DD)
export component AuthorsPage inherits Page {
    // Page title and description (internationalized)
    title: @tr("Authors");
    description: @tr("Manage book authors in your library");

    // ========================================================================
    // Properties
    // ========================================================================

    // Array of all authors loaded from the backend
    in-out property <[AuthorData]> authors: [];

    // Whether the create author dialog is currently visible
    in-out property <bool> show-create-dialog: false;

    // Form fields for creating a new author
    in-out property <string> new-first-name: "";        // Required
    in-out property <string> new-last-name: "";         // Required
    in-out property <string> new-biography: "";         // Optional multi-line text
    in-out property <string> new-birth-date: "";        // Optional, ISO format (YYYY-MM-DD)
    in-out property <string> new-death-date: "";        // Optional, ISO format (YYYY-MM-DD)
    in-out property <string> new-nationality: "";       // Optional
    in-out property <string> new-website-url: "";       // Optional

    // Edit dialog state
    in-out property <bool> show-edit-dialog: false;     // Whether edit dialog is visible
    in-out property <string> edit-id: "";               // ID of author being edited
    in-out property <string> edit-first-name: "";       // Updated first name (required)
    in-out property <string> edit-last-name: "";        // Updated last name (required)
    in-out property <string> edit-biography: "";        // Updated biography (optional)
    in-out property <string> edit-birth-date: "";       // Updated birth date (optional)
    in-out property <string> edit-death-date: "";       // Updated death date (optional)
    in-out property <string> edit-nationality: "";      // Updated nationality (optional)
    in-out property <string> edit-website-url: "";      // Updated website URL (optional)

    // ========================================================================
    // Callbacks (connected to Rust backend)
    // ========================================================================

    // Triggers reloading of all authors from the backend
    callback load-authors();

    // Creates a new author in the database
    // Parameters: first_name, last_name, biography, birth_date, death_date, nationality, website_url
    callback create-author(string, string, string, string, string, string, string);

    // Updates an existing author's information
    // Parameters: id, first_name, last_name, biography, birth_date, death_date, nationality, website_url
    callback update-author(string, string, string, string, string, string, string, string);

    // Deletes an author by ID
    // Parameter: author id (UUID string)
    // Note: May fail if author has associated titles
    callback delete-author(string);

    // ========================================================================
    // Main Content Layout
    // ========================================================================
    VerticalBox {
        alignment: stretch;
        padding: 20px;

        // ====================================================================
        // Header Section - Title and action buttons
        // ====================================================================
        HorizontalBox {
            alignment: space-between;
            height: 50px;

            // Page title
            Text {
                text: @tr("Authors");
                font-size: 24px;
                font-weight: 700;
            }

            // Action buttons (right-aligned)
            HorizontalBox {
                spacing: 10px;

                // Refresh button - reloads authors from backend
                Button {
                    text: @tr("Refresh");
                    min-width: 100px;
                    height: 35px;
                    clicked => {
                        root.load-authors();
                    }
                }

                // New Author button - opens create dialog
                Button {
                    text: @tr("+ New Author");
                    primary: true;
                    min-width: 150px;
                    height: 35px;
                    clicked => {
                        // Show dialog and reset all form fields
                        root.show-create-dialog = true;
                        root.new-first-name = "";
                        root.new-last-name = "";
                        root.new-biography = "";
                        root.new-birth-date = "";
                        root.new-death-date = "";
                        root.new-nationality = "";
                        root.new-website-url = "";
                    }
                }
            }
        }

        // ====================================================================
        // Create Author Dialog - Modal form for adding new authors
        // ====================================================================
        // This dialog appears when show-create-dialog is true.
        // It provides form fields for all author attributes.
        if show-create-dialog: Rectangle {
            background: white;
            border-width: 2px;
            border-color: #0066cc;
            border-radius: 8px;

            VerticalBox {
                padding: 20px;
                spacing: 12px;

                // Dialog title
                Text {
                    text: @tr("Create New Author");
                    font-size: 18px;
                    font-weight: 600;
                }

                // First Name field (REQUIRED)
                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: @tr("First Name:");
                        width: 120px;
                        vertical-alignment: center;
                    }
                    LineEdit {
                        text <=> root.new-first-name;
                        placeholder-text: @tr("First name (required)");
                    }
                }

                // Last Name field (REQUIRED)
                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: @tr("Last Name:");
                        width: 120px;
                        vertical-alignment: center;
                    }
                    LineEdit {
                        text <=> root.new-last-name;
                        placeholder-text: @tr("Last name (required)");
                    }
                }

                // Biography field (Optional multi-line)
                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: @tr("Biography:");
                        width: 120px;
                        vertical-alignment: top;
                    }
                    TextEdit {
                        text <=> root.new-biography;
                        height: 80px;
                    }
                }

                // Birth Date field (Optional, ISO format)
                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: @tr("Birth Date:");
                        width: 120px;
                        vertical-alignment: center;
                    }
                    LineEdit {
                        text <=> root.new-birth-date;
                        placeholder-text: @tr("YYYY-MM-DD");
                    }
                }

                // Death Date field (Optional, ISO format)
                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: @tr("Death Date:");
                        width: 120px;
                        vertical-alignment: center;
                    }
                    LineEdit {
                        text <=> root.new-death-date;
                        placeholder-text: @tr("YYYY-MM-DD");
                    }
                }

                // Nationality field (Optional)
                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: @tr("Nationality:");
                        width: 120px;
                        vertical-alignment: center;
                    }
                    LineEdit {
                        text <=> root.new-nationality;
                        placeholder-text: @tr("E.g., American, British");
                    }
                }

                // Website URL field (Optional)
                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: @tr("Website:");
                        width: 120px;
                        vertical-alignment: center;
                    }
                    LineEdit {
                        text <=> root.new-website-url;
                        placeholder-text: @tr("https://...");
                    }
                }

                // Dialog action buttons (Cancel and Create)
                HorizontalBox {
                    spacing: 10px;
                    alignment: end;

                    // Cancel button - closes dialog without creating
                    Button {
                        text: @tr("Cancel");
                        min-width: 100px;
                        height: 35px;
                        clicked => {
                            root.show-create-dialog = false;
                        }
                    }

                    // Create button - submits form and creates author
                    // Disabled if required fields (first name, last name) are empty
                    Button {
                        text: @tr("Create");
                        primary: true;
                        min-width: 100px;
                        height: 35px;
                        enabled: root.new-first-name != "" && root.new-last-name != "";
                        clicked => {
                            // Call backend to create author
                            root.create-author(
                                root.new-first-name,
                                root.new-last-name,
                                root.new-biography,
                                root.new-birth-date,
                                root.new-death-date,
                                root.new-nationality,
                                root.new-website-url
                            );
                            // Close dialog after submission
                            root.show-create-dialog = false;
                        }
                    }
                }
            }
        }

        // ====================================================================
        // Edit Author Dialog - Modal form for updating existing authors
        // ====================================================================
        // This dialog appears when show-edit-dialog is true.
        // It provides the same form fields as create, pre-filled with existing data.
        if show-edit-dialog: Rectangle {
            background: white;
            border-width: 2px;
            border-color: #0066cc;
            border-radius: 8px;

            VerticalBox {
                padding: 20px;
                spacing: 12px;

                // Dialog title
                Text {
                    text: @tr("Edit Author");
                    font-size: 18px;
                    font-weight: 600;
                }

                // First Name field (REQUIRED)
                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: @tr("First Name:");
                        width: 120px;
                        vertical-alignment: center;
                    }
                    LineEdit {
                        text <=> root.edit-first-name;
                        placeholder-text: @tr("First name (required)");
                    }
                }

                // Last Name field (REQUIRED)
                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: @tr("Last Name:");
                        width: 120px;
                        vertical-alignment: center;
                    }
                    LineEdit {
                        text <=> root.edit-last-name;
                        placeholder-text: @tr("Last name (required)");
                    }
                }

                // Biography field (Optional multi-line)
                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: @tr("Biography:");
                        width: 120px;
                        vertical-alignment: top;
                    }
                    TextEdit {
                        text <=> root.edit-biography;
                        height: 80px;
                    }
                }

                // Birth Date field (Optional, ISO format)
                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: @tr("Birth Date:");
                        width: 120px;
                        vertical-alignment: center;
                    }
                    LineEdit {
                        text <=> root.edit-birth-date;
                        placeholder-text: @tr("YYYY-MM-DD");
                    }
                }

                // Death Date field (Optional, ISO format)
                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: @tr("Death Date:");
                        width: 120px;
                        vertical-alignment: center;
                    }
                    LineEdit {
                        text <=> root.edit-death-date;
                        placeholder-text: @tr("YYYY-MM-DD");
                    }
                }

                // Nationality field (Optional)
                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: @tr("Nationality:");
                        width: 120px;
                        vertical-alignment: center;
                    }
                    LineEdit {
                        text <=> root.edit-nationality;
                        placeholder-text: @tr("E.g., American, British");
                    }
                }

                // Website URL field (Optional)
                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: @tr("Website:");
                        width: 120px;
                        vertical-alignment: center;
                    }
                    LineEdit {
                        text <=> root.edit-website-url;
                        placeholder-text: @tr("https://...");
                    }
                }

                // Dialog action buttons (Cancel and Save)
                HorizontalBox {
                    spacing: 10px;
                    alignment: end;

                    // Cancel button - closes dialog without saving changes
                    Button {
                        text: @tr("Cancel");
                        min-width: 100px;
                        height: 35px;
                        clicked => {
                            root.show-edit-dialog = false;
                        }
                    }

                    // Save button - submits form and updates author
                    // Disabled if required fields (first name, last name) are empty
                    Button {
                        text: @tr("Save");
                        primary: true;
                        min-width: 100px;
                        height: 35px;
                        enabled: root.edit-first-name != "" && root.edit-last-name != "";
                        clicked => {
                            // Call backend to update author
                            root.update-author(
                                root.edit-id,
                                root.edit-first-name,
                                root.edit-last-name,
                                root.edit-biography,
                                root.edit-birth-date,
                                root.edit-death-date,
                                root.edit-nationality,
                                root.edit-website-url
                            );
                            // Close dialog after submission
                            root.show-edit-dialog = false;
                        }
                    }
                }
            }
        }

        // ====================================================================
        // Empty State - Shown when no authors exist
        // ====================================================================
        if authors.length == 0 && !show-create-dialog && !show-edit-dialog: Rectangle {
            height: 100px;
            Text {
                text: @tr("No authors found. Click 'New Author' to create one.");
                color: #888;
                horizontal-alignment: center;
                vertical-alignment: center;
            }
        }

        // ====================================================================
        // Author List - Card-based list view of all authors
        // ====================================================================
        // Each author is displayed as a card with biographical information,
        // title count badge, and action buttons.
        if authors.length > 0: ListView {
            // Each author item is rendered as a card
            for author[index] in authors: Rectangle {
                height: 90px;
                border-width: 1px;
                border-color: #ddd;
                border-radius: 4px;
                // Alternating row colors for better readability
                background: Math.mod(index, 2) == 0 ? #fafafa : white;

                HorizontalLayout {
                    padding: 12px;
                    spacing: 10px;

                    // Left side: Author biographical information
                    VerticalLayout {
                        alignment: start;
                        spacing: 5px;

                        // Author name and title count badge
                        HorizontalBox {
                            spacing: 8px;

                            // Full name (first + last)
                            Text {
                                text: author.first-name + " " + author.last-name;
                                font-size: 16px;
                                font-weight: 700;
                                overflow: elide;
                            }

                            // Title count badge (only shown if author has books)
                            if author.title-count > 0: Rectangle {
                                background: #0066cc;
                                border-radius: 10px;
                                width: 50px;
                                height: 20px;

                                Text {
                                    text: author.title-count + " books";
                                    color: white;
                                    font-size: 11px;
                                    horizontal-alignment: center;
                                    vertical-alignment: center;
                                }
                            }
                        }

                        // Nationality and dates row (conditional)
                        // Only shown if author has nationality or birth date
                        if author.nationality != "" || author.birth-date != "": HorizontalBox {
                            spacing: 12px;

                            // Nationality with globe emoji
                            if author.nationality != "": Text {
                                text: "ðŸŒ " + author.nationality;
                                font-size: 12px;
                                color: #666;
                                overflow: elide;
                            }

                            // Birth and death dates with calendar emoji
                            // Shows "birth - death" if both available, otherwise just birth
                            if author.birth-date != "": Text {
                                text: "ðŸ“… " + author.birth-date + (author.death-date != "" ? " - " + author.death-date : "");
                                font-size: 12px;
                                color: #666;
                                overflow: elide;
                            }
                        }

                        // Biography excerpt (conditional)
                        if author.biography != "": Text {
                            text: author.biography;
                            font-size: 11px;
                            color: #888;
                            overflow: elide;
                        }

                        // Website URL with link emoji (conditional)
                        if author.website-url != "": Text {
                            text: "ðŸ”— " + author.website-url;
                            font-size: 11px;
                            color: #0066cc;
                            overflow: elide;
                        }
                    }

                    // Right side: Action buttons
                    VerticalBox {
                        width: 100px;
                        spacing: 5px;
                        alignment: center;

                        // Edit button - opens edit dialog with pre-filled data
                        Button {
                            text: @tr("Edit");
                            min-width: 80px;
                            height: 32px;
                            clicked => {
                                // Pre-fill edit form with current author data
                                root.edit-id = author.id;
                                root.edit-first-name = author.first-name;
                                root.edit-last-name = author.last-name;
                                root.edit-biography = author.biography;
                                root.edit-birth-date = author.birth-date;
                                root.edit-death-date = author.death-date;
                                root.edit-nationality = author.nationality;
                                root.edit-website-url = author.website-url;
                                // Show edit dialog
                                root.show-edit-dialog = true;
                            }
                        }

                        // Delete button - removes author from database
                        // Note: May fail if author has associated titles
                        Button {
                            text: @tr("Delete");
                            min-width: 80px;
                            height: 32px;
                            clicked => {
                                root.delete-author(author.id);
                            }
                        }
                    }
                }
            }
        }
    }
}
