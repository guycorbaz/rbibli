import { Page } from "page.slint";
import { ListView, VerticalBox, HorizontalBox, Button, LineEdit, TextEdit, ComboBox } from "std-widgets.slint";

// Structure to hold title data
export struct TitleData {
    id: string,
    title: string,
    subtitle: string,
    isbn: string,
    publisher: string,
    volume-count: int,
    language: string,
    publication-year: string,
    pages: string,
    genre: string,
    genre-id: string,
    summary: string,
}

// Structure for genre dropdown
export struct GenreItem {
    id: string,
    name: string,
}

export component TitlesPage inherits Page {
    title: @tr("Titles");
    description: @tr("Manage your book titles and volumes");

    // Property to hold the list of titles
    in-out property <[TitleData]> titles: [];
    in-out property <[GenreItem]> genres: [];
    in-out property <[string]> genre-names: [];
    in-out property <bool> show-create-dialog: false;
    in-out property <string> new-title: "";
    in-out property <string> new-subtitle: "";
    in-out property <string> new-isbn: "";
    in-out property <string> new-publisher: "";
    in-out property <string> new-publication-year: "";
    in-out property <string> new-pages: "";
    in-out property <string> new-language: "fr";
    in-out property <int> new-genre-index: -1;
    in-out property <string> new-genre-id: "";
    in-out property <string> new-summary: "";

    // Edit dialog properties
    in-out property <bool> show-edit-dialog: false;
    in-out property <string> edit-id: "";
    in-out property <string> edit-title: "";
    in-out property <string> edit-subtitle: "";
    in-out property <string> edit-isbn: "";
    in-out property <string> edit-publisher: "";
    in-out property <string> edit-publication-year: "";
    in-out property <string> edit-pages: "";
    in-out property <string> edit-language: "";
    in-out property <int> edit-genre-index: -1;
    in-out property <string> edit-genre-id: "";
    in-out property <string> edit-summary: "";

    // Delete confirmation dialog properties
    in-out property <bool> show-delete-confirmation: false;
    in-out property <string> delete-title-id: "";
    in-out property <string> delete-title-name: "";

    // Callback to request loading titles
    callback load-titles();
    callback create-title(string, string, string, string, string, string, string, string, string); // title, subtitle, isbn, publisher, publication_year, pages, language, genre_id, summary
    callback update-title(string, string, string, string, string, string, string, string, string, string); // id, title, subtitle, isbn, publisher, publication_year, pages, language, genre_id, summary
    callback delete-title(string); // id
    callback find-genre-index(string) -> int; // Find genre index by ID

    VerticalBox {
        alignment: stretch;
        padding: 20px;

        HorizontalBox {
            alignment: space-between;
            height: 50px;

            Text {
                text: @tr("Book Titles");
                font-size: 24px;
                font-weight: 700;
            }

            HorizontalBox {
                spacing: 10px;

                Button {
                    text: @tr("Refresh");
                    min-width: 100px;
                    height: 35px;
                    clicked => {
                        root.load-titles();
                    }
                }

                Button {
                    text: @tr("+ New Title");
                    primary: true;
                    min-width: 150px;
                    height: 35px;
                    clicked => {
                        root.show-create-dialog = true;
                        root.new-title = "";
                        root.new-subtitle = "";
                        root.new-isbn = "";
                        root.new-publisher = "";
                        root.new-publication-year = "";
                        root.new-pages = "";
                        root.new-language = "fr";
                        root.new-genre-index = -1;
                        root.new-genre-id = "";
                        root.new-summary = "";
                    }
                }
            }
        }

        // Create title dialog
        if show-create-dialog: Rectangle {
            background: white;
            border-width: 2px;
            border-color: #0066cc;
            border-radius: 8px;
            height: 750px;

            VerticalBox {
                padding: 20px;
                spacing: 12px;

                Text {
                    text: @tr("Create New Title");
                    font-size: 18px;
                    font-weight: 600;
                }

                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: @tr("Title:");
                        width: 120px;
                        vertical-alignment: center;
                    }
                    LineEdit {
                        text <=> root.new-title;
                        placeholder-text: @tr("Title (required)");
                    }
                }

                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: @tr("Subtitle:");
                        width: 120px;
                        vertical-alignment: center;
                    }
                    LineEdit {
                        text <=> root.new-subtitle;
                        placeholder-text: @tr("Subtitle (optional)");
                    }
                }

                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: @tr("ISBN:");
                        width: 120px;
                        vertical-alignment: center;
                    }
                    LineEdit {
                        text <=> root.new-isbn;
                        placeholder-text: @tr("ISBN-13 or ISBN-10");
                    }
                }

                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: @tr("Publisher:");
                        width: 120px;
                        vertical-alignment: center;
                    }
                    LineEdit {
                        text <=> root.new-publisher;
                        placeholder-text: @tr("Publisher name");
                    }
                }

                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: @tr("Pub. Year:");
                        width: 120px;
                        vertical-alignment: center;
                    }
                    LineEdit {
                        text <=> root.new-publication-year;
                        placeholder-text: @tr("E.g., 2024");
                    }
                }

                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: @tr("Pages:");
                        width: 120px;
                        vertical-alignment: center;
                    }
                    LineEdit {
                        text <=> root.new-pages;
                        placeholder-text: @tr("Number of pages");
                    }
                }

                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: @tr("Language:");
                        width: 120px;
                        vertical-alignment: center;
                    }
                    LineEdit {
                        text <=> root.new-language;
                        placeholder-text: @tr("E.g., fr, en, es");
                    }
                }

                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: @tr("Genre:");
                        width: 120px;
                        vertical-alignment: center;
                    }
                    ComboBox {
                        model: root.genre-names;
                        current-index <=> root.new-genre-index;
                    }
                }

                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: @tr("Summary:");
                        width: 120px;
                        vertical-alignment: top;
                    }
                    TextEdit {
                        text <=> root.new-summary;
                        height: 100px;
                    }
                }

                HorizontalBox {
                    spacing: 10px;
                    alignment: end;

                    Button {
                        text: @tr("Cancel");
                        min-width: 100px;
                        height: 35px;
                        clicked => {
                            root.show-create-dialog = false;
                        }
                    }

                    Button {
                        text: @tr("Save");
                        primary: true;
                        min-width: 100px;
                        height: 35px;
                        enabled: root.new-title != "";
                        clicked => {
                            // Look up genre_id from index
                            if (root.new-genre-index >= 0 && root.new-genre-index < root.genres.length) {
                                root.create-title(
                                    root.new-title,
                                    root.new-subtitle,
                                    root.new-isbn,
                                    root.new-publisher,
                                    root.new-publication-year,
                                    root.new-pages,
                                    root.new-language,
                                    root.genres[root.new-genre-index].id,
                                    root.new-summary
                                );
                            } else {
                                root.create-title(
                                    root.new-title,
                                    root.new-subtitle,
                                    root.new-isbn,
                                    root.new-publisher,
                                    root.new-publication-year,
                                    root.new-pages,
                                    root.new-language,
                                    "",
                                    root.new-summary
                                );
                            }
                            root.show-create-dialog = false;
                        }
                    }
                }
            }
        }

        // Edit title dialog
        if show-edit-dialog: Rectangle {
            background: white;
            border-width: 2px;
            border-color: #0066cc;
            border-radius: 8px;
            height: 750px;

            VerticalBox {
                padding: 20px;
                spacing: 12px;

                Text {
                    text: @tr("Edit Title");
                    font-size: 18px;
                    font-weight: 600;
                }

                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: @tr("Title:");
                        width: 120px;
                        vertical-alignment: center;
                    }
                    LineEdit {
                        text <=> root.edit-title;
                        placeholder-text: @tr("Title (required)");
                    }
                }

                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: @tr("Subtitle:");
                        width: 120px;
                        vertical-alignment: center;
                    }
                    LineEdit {
                        text <=> root.edit-subtitle;
                        placeholder-text: @tr("Subtitle (optional)");
                    }
                }

                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: @tr("ISBN:");
                        width: 120px;
                        vertical-alignment: center;
                    }
                    LineEdit {
                        text <=> root.edit-isbn;
                        placeholder-text: @tr("ISBN-13 or ISBN-10");
                    }
                }

                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: @tr("Publisher:");
                        width: 120px;
                        vertical-alignment: center;
                    }
                    LineEdit {
                        text <=> root.edit-publisher;
                        placeholder-text: @tr("Publisher name");
                    }
                }

                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: @tr("Pub. Year:");
                        width: 120px;
                        vertical-alignment: center;
                    }
                    LineEdit {
                        text <=> root.edit-publication-year;
                        placeholder-text: @tr("E.g., 2024");
                    }
                }

                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: @tr("Pages:");
                        width: 120px;
                        vertical-alignment: center;
                    }
                    LineEdit {
                        text <=> root.edit-pages;
                        placeholder-text: @tr("Number of pages");
                    }
                }

                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: @tr("Language:");
                        width: 120px;
                        vertical-alignment: center;
                    }
                    LineEdit {
                        text <=> root.edit-language;
                        placeholder-text: @tr("E.g., fr, en, es");
                    }
                }

                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: @tr("Genre:");
                        width: 120px;
                        vertical-alignment: center;
                    }
                    ComboBox {
                        model: root.genre-names;
                        current-index <=> root.edit-genre-index;
                    }
                }

                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: @tr("Summary:");
                        width: 120px;
                        vertical-alignment: top;
                    }
                    TextEdit {
                        text <=> root.edit-summary;
                        height: 100px;
                    }
                }

                HorizontalBox {
                    spacing: 10px;
                    alignment: end;

                    Button {
                        text: @tr("Cancel");
                        min-width: 100px;
                        height: 35px;
                        clicked => {
                            root.show-edit-dialog = false;
                        }
                    }

                    Button {
                        text: @tr("Save");
                        primary: true;
                        min-width: 100px;
                        height: 35px;
                        enabled: root.edit-title != "";
                        clicked => {
                            // Look up genre_id from index
                            if (root.edit-genre-index >= 0 && root.edit-genre-index < root.genres.length) {
                                root.update-title(
                                    root.edit-id,
                                    root.edit-title,
                                    root.edit-subtitle,
                                    root.edit-isbn,
                                    root.edit-publisher,
                                    root.edit-publication-year,
                                    root.edit-pages,
                                    root.edit-language,
                                    root.genres[root.edit-genre-index].id,
                                    root.edit-summary
                                );
                            } else {
                                root.update-title(
                                    root.edit-id,
                                    root.edit-title,
                                    root.edit-subtitle,
                                    root.edit-isbn,
                                    root.edit-publisher,
                                    root.edit-publication-year,
                                    root.edit-pages,
                                    root.edit-language,
                                    "",
                                    root.edit-summary
                                );
                            }
                            root.show-edit-dialog = false;
                        }
                    }
                }
            }
        }

        // Delete confirmation dialog
        if show-delete-confirmation: Rectangle {
            background: white;
            border-width: 2px;
            border-color: #cc0000;
            border-radius: 8px;
            width: 500px;
            height: 200px;

            VerticalBox {
                padding: 20px;
                spacing: 20px;

                Text {
                    text: @tr("Delete Title?");
                    font-size: 18px;
                    font-weight: 600;
                    color: #cc0000;
                }

                Text {
                    text: @tr("Are you sure you want to delete this title?\n\n") + "\"" + root.delete-title-name + "\"";
                    font-size: 14px;
                    color: #333;
                    wrap: word-wrap;
                }

                HorizontalBox {
                    spacing: 10px;
                    alignment: end;

                    Button {
                        text: @tr("Cancel");
                        min-width: 100px;
                        height: 35px;
                        clicked => {
                            root.show-delete-confirmation = false;
                        }
                    }

                    Button {
                        text: @tr("Delete");
                        primary: true;
                        min-width: 100px;
                        height: 35px;
                        clicked => {
                            root.delete-title(root.delete-title-id);
                            root.show-delete-confirmation = false;
                        }
                    }
                }
            }
        }

        // List of titles
        if titles.length == 0 && !show-create-dialog && !show-edit-dialog && !show-delete-confirmation: Text {
            text: @tr("No titles found. Click Refresh to load titles from the backend.");
            color: #888;
        }

        if titles.length > 0: ListView {
            for title[index] in titles: Rectangle {
                height: 80px;
                border-width: 1px;
                border-color: #ddd;
                border-radius: 4px;
                background: Math.mod(index, 2) == 0 ? #fafafa : white;

                HorizontalLayout {
                    padding: 8px;
                    spacing: 10px;

                    VerticalLayout {
                        alignment: start;
                        spacing: 4px;

                        Text {
                            text: title.title;
                            font-size: 15px;
                            font-weight: 600;
                            overflow: elide;
                        }

                        if title.subtitle != "": Text {
                            text: title.subtitle;
                            font-size: 13px;
                            color: #666;
                            overflow: elide;
                        }

                        HorizontalBox {
                            spacing: 15px;

                            if title.isbn != "": Text {
                                text: "ISBN: " + title.isbn;
                                font-size: 11px;
                                color: #888;
                            }

                            if title.publisher != "": Text {
                                text: title.publisher;
                                font-size: 11px;
                                color: #888;
                                overflow: elide;
                            }

                            Text {
                                text: "Volumes: " + title.volume-count;
                                font-size: 11px;
                                color: #0066cc;
                                font-weight: 600;
                            }

                            Text {
                                text: title.language;
                                font-size: 11px;
                                color: #888;
                            }
                        }
                    }

                    VerticalLayout {
                        alignment: center;
                        spacing: 5px;
                        width: 90px;

                        Button {
                            text: @tr("Edit");
                            min-width: 80px;
                            height: 32px;
                            clicked => {
                                root.edit-id = title.id;
                                root.edit-title = title.title;
                                root.edit-subtitle = title.subtitle;
                                root.edit-isbn = title.isbn;
                                root.edit-publisher = title.publisher;
                                root.edit-publication-year = title.publication-year;
                                root.edit-pages = title.pages;
                                root.edit-language = title.language;
                                root.edit-genre-id = title.genre-id;
                                // Find the genre index for this genre_id
                                root.edit-genre-index = root.find-genre-index(title.genre-id);
                                root.edit-summary = title.summary;
                                root.show-edit-dialog = true;
                            }
                        }

                        Button {
                            text: @tr("Delete");
                            min-width: 80px;
                            height: 32px;
                            enabled: title.volume-count == 0;
                            clicked => {
                                root.delete-title-id = title.id;
                                root.delete-title-name = title.title;
                                root.show-delete-confirmation = true;
                            }
                        }
                    }
                }
            }
        }
    }
}
