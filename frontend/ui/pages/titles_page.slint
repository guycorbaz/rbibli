// ============================================================================
// titles_page.slint
// ============================================================================
// Titles management page for the rbibli personal library application.
//
// This page is the central hub for managing the library's book collection.
// It provides a comprehensive interface for:
// - Viewing a list of all book titles
// - Searching and filtering titles by various criteria (author, genre, etc.)
// - Creating new titles manually or by fetching metadata via ISBN
// - Editing existing title details
// - Managing volumes (copies) associated with each title
// - Managing authors associated with each title
// - Detecting and merging duplicate titles
//
// The page features a complex layout with:
// - A top bar for global actions (Refresh, New Title, Find Duplicates)
// - A collapsible search/filter panel with basic and advanced options
// - A main list view displaying title cards
// - Expandable title cards showing detailed information and volumes
// - Modal dialogs for creating/editing titles, volumes, and authors
//
// Key Features:
// - ISBN Lookup: Fetches book data from Google Books API
// - Duplicate Detection: Identifies potential duplicates based on similarity
// - Volume Management: Tracks individual copies, barcodes, and locations
// - Author Management: Handles multiple authors with specific roles
//
// All text is internationalized using @tr() for multi-language support.
// ============================================================================

import { Styles } from "../styles.slint";
import { Page } from "page.slint";
import {
    ListView,
    ScrollView,
    VerticalBox,
    HorizontalBox,
    Button,
    LineEdit,
    TextEdit,
    ComboBox,
} from "std-widgets.slint";
import { LocationData } from "locations_page.slint";

// Structure to hold title data
export struct TitleData {
    id: string,
    title: string,
    subtitle: string,
    isbn: string,
    publisher: string,
    publisher-id: string,
    volume-count: int,
    language: string,
    publication-year: string,
    pages: string,
    genre: string,
    genre-id: string,
    series-name: string,
    series-id: string,
    series-number: string,
    dewey-code: string,
    summary: string,
    cover-url: string,
    // Duplicate detection fields
    is-duplicate: bool,
    duplicate-pair-id: string,  // ID of the paired duplicate title
    duplicate-similarity: float,  // Similarity score (0-100)
    duplicate-confidence: string,  // "High", "Medium", "Low"
    duplicate-match-reasons: string,  // Comma-separated match reasons
    is-duplicate-primary: bool,  // true if this should be the primary in merge
}

// Structure for genre dropdown
export struct GenreItem {
    id: string,
    name: string,
}

// Structure for publisher dropdown
export struct PublisherItem {
    id: string,
    name: string,
}

// Structure for series dropdown
export struct SeriesItem {
    id: string,
    name: string,
}

// Structure to hold volume data
export struct VolumeData {
    id: string,
    title-id: string,
    copy-number: int,
    barcode: string,
    condition: string,
    location-id: string,
    location-name: string,  // Full path of location for display
    loan-status: string,
    individual-notes: string,
}

// Structure for author with role
export struct AuthorWithRoleData {
    author-id: string,
    first-name: string,
    last-name: string,
    role: string,  // main_author, co_author, translator, illustrator, editor
    display-order: int,
}

// Structure for author dropdown
export struct AuthorItem {
    id: string,
    name: string,  // Full name (first + last)
}

export component TitlesPage inherits Page {
    title: @tr("Titles");
    description: @tr("Manage your book titles and volumes");

    // Property to hold the list of titles
    in-out property <[TitleData]> titles: [];
    in-out property <[GenreItem]> genres: [];
    in-out property <[string]> genre-names: [];
    in-out property <[PublisherItem]> publishers: [];
    in-out property <[string]> publisher-names: [];
    in-out property <[SeriesItem]> series-list: [];
    in-out property <[string]> series-names: [];
    in-out property <[LocationData]> locations: [];
    in-out property <[string]> location-names: [];
    in-out property <bool> show-create-dialog: false;
    in-out property <string> new-title: "";
    in-out property <string> new-subtitle: "";
    in-out property <string> new-isbn: "";
    in-out property <string> new-publisher: "";
    in-out property <int> new-publisher-index: -1;
    in-out property <string> new-publisher-id: "";
    in-out property <string> new-publication-year: "";
    in-out property <string> new-pages: "";
    in-out property <string> new-language: "fr";
    in-out property <int> new-genre-index: -1;
    in-out property <string> new-genre-id: "";
    in-out property <int> new-series-index: -1;
    in-out property <string> new-series-id: "";
    in-out property <string> new-series-number: "";
    in-out property <string> new-dewey-code: "";
    in-out property <string> new-summary: "";
    in-out property <string> new-cover-url: "";

    // Edit dialog properties
    in-out property <bool> show-edit-dialog: false;
    in-out property <string> edit-id: "";
    in-out property <string> edit-title: "";
    in-out property <string> edit-subtitle: "";
    in-out property <string> edit-isbn: "";
    in-out property <string> edit-publisher: "";
    in-out property <int> edit-publisher-index: -1;
    in-out property <string> edit-publisher-id: "";
    in-out property <string> edit-publication-year: "";
    in-out property <string> edit-pages: "";
    in-out property <string> edit-language: "";
    in-out property <int> edit-genre-index: -1;
    in-out property <string> edit-genre-id: "";
    in-out property <int> edit-series-index: -1;
    in-out property <string> edit-series-id: "";
    in-out property <string> edit-series-number: "";
    in-out property <string> edit-dewey-code: "";
    in-out property <string> edit-summary: "";
    in-out property <string> edit-cover-url: "";

    // Delete confirmation dialog properties
    in-out property <bool> show-delete-confirmation: false;
    in-out property <string> delete-title-id: "";
    in-out property <string> delete-title-name: "";

    // Volume-related properties
    in-out property <[VolumeData]> volumes: [];
    in-out property <string> expanded-title-id: "";  // Which title has volumes expanded
    in-out property <bool> show-volume-create-dialog: false;
    in-out property <bool> show-volume-delete-confirmation: false;
    in-out property <string> volume-create-title-id: "";
    in-out property <string> volume-barcode: "";
    in-out property <string> volume-condition: "Good";
    in-out property <int> volume-location-index: -1;  // Index in locations dropdown
    in-out property <string> volume-location-id: "";
    in-out property <string> volume-notes: "";
    in-out property <string> delete-volume-id: "";
    in-out property <string> delete-volume-barcode: "";
    in-out property <string> volume-create-error: "";

    // Volume edit dialog properties
    in-out property <bool> show-volume-edit-dialog: false;
    in-out property <string> edit-volume-id: "";
    in-out property <string> edit-volume-barcode: "";
    in-out property <string> edit-volume-condition: "Good";
    in-out property <int> edit-volume-location-index: -1;
    in-out property <string> edit-volume-location-id: "";
    in-out property <string> edit-volume-notes: "";

    // Author-related properties
    in-out property <[AuthorWithRoleData]> title-authors: [];
    in-out property <string> managing-authors-title-id: "";  // Which title is having authors managed
    in-out property <bool> show-authors-dialog: false;
    in-out property <[AuthorItem]> all-authors: [];
    in-out property <[string]> author-names: [];
    in-out property <[string]> role-names: ["Main Author", "Co-Author", "Translator", "Illustrator", "Editor"];
    in-out property <int> add-author-index: -1;
    in-out property <int> add-author-role-index: 0;

    // Search/Filter properties
    in-out property <bool> show-filters: false;  // Toggle for filter panel visibility
    in-out property <bool> show-advanced-filters: false;  // Toggle for advanced filters section
    in-out property <string> filter-search-text: "";  // Free text search (q parameter)
    in-out property <string> filter-title: "";  // Title filter (partial match)
    in-out property <string> filter-subtitle: "";  // Subtitle filter
    in-out property <string> filter-isbn: "";  // ISBN filter
    in-out property <int> filter-series-index: -1;  // Series dropdown index
    in-out property <int> filter-author-index: -1;  // Author dropdown index
    in-out property <int> filter-genre-index: -1;  // Genre dropdown index
    in-out property <int> filter-publisher-index: -1;  // Publisher dropdown index
    in-out property <string> filter-year-from: "";  // Publication year from
    in-out property <string> filter-year-to: "";  // Publication year to
    in-out property <string> filter-language: "";  // Language code (en, fr, etc.)
    in-out property <string> filter-dewey-code: "";  // Dewey classification filter
    in-out property <bool> filter-has-volumes: false;  // Owned books only
    in-out property <bool> filter-wishlist-only: false;  // Wishlist only
    in-out property <bool> filter-available-only: false;  // Available volumes only
    in-out property <int> filter-location-index: -1;  // Location dropdown index

    // Duplicate detection properties
    in-out property <bool> show-duplicates-dialog: false;
    in-out property <int> duplicate-count: 0;
    in-out property <string> duplicate-primary-id: "";  // Selected primary title for merge
    in-out property <string> duplicate-secondary-id: "";  // Selected secondary title for merge
    in-out property <string> duplicate-status-message: "";  // Status message for duplicate operations

    // Duplicate filter properties
    in-out property <bool> filter-show-only-duplicates: false;  // Show only duplicate titles
    in-out property <bool> filter-duplicates-high: true;  // Show high confidence duplicates
    in-out property <bool> filter-duplicates-medium: true;  // Show medium confidence duplicates
    in-out property <bool> filter-duplicates-low: true;  // Show low confidence duplicates
    in-out property <bool> duplicates-detected: false;  // Whether duplicates have been detected

    // Callback to request loading titles
    callback load-titles();
    callback search-titles(string, string, string, string, string, string, string, string, string, string, string, string, bool, bool, bool, string); // search_text, title, subtitle, isbn, series_id, author_id, genre_id, publisher_id, year_from, year_to, language, dewey_code, has_volumes, wishlist_only, available_only, location_id
    callback find-duplicates();  // Triggers duplicate detection scan
    callback merge-titles(string, string);  // primary_id, secondary_id - Merges secondary into primary
    callback dismiss-duplicate(string, string);  // title1_id, title2_id - Mark pair as not duplicate
    callback clear-duplicates();  // Clear all duplicate detection results
    callback create-title(string, string, string, string, string, string, string, string, string, string, string, string, string, string); // title, subtitle, isbn, publisher, publisher_id, publication_year, pages, language, genre_id, series_id, series_number, summary, cover_url, dewey_code
    callback update-title(string, string, string, string, string, string, string, string, string, string, string, string, string, string, string); // id, title, subtitle, isbn, publisher, publisher_id, publication_year, pages, language, genre_id, series_id, series_number, summary, cover_url, dewey_code
    callback delete-title(string); // id
    callback upload-image(string); // title_id
    callback fetch-from-isbn(string); // isbn - fetches and populates create form fields
    callback fetch-from-isbn-edit(string); // isbn - fetches and populates edit form fields
    callback find-genre-index(string) -> int; // Find genre index by ID
    callback find-publisher-index(string) -> int; // Find publisher index by ID
    callback find-series-index(string) -> int; // Find series index by ID
    callback find-location-index(string) -> int; // Find location index by ID

    // Volume callbacks
    callback load-volumes(string); // title-id
    callback create-volume(string, string, string, string, string); // title-id, barcode, condition, location-id, notes
    callback update-volume(string, string, string, string, string); // id, barcode, condition, location-id, notes
    callback delete-volume(string); // id

    // Author callbacks
    callback load-title-authors(string); // title-id
    callback load-all-authors(); // Load all authors for dropdown
    callback add-author-to-title(string, string, string); // title-id, author-id, role
    callback remove-author-from-title(string, string); // title-id, author-id

    VerticalBox {
        alignment: stretch;
        padding: 20px;

        HorizontalBox {
            alignment: space-between;
            height: 50px;

            Text {
                text: @tr("Book Titles");
                font-size: 24px;
                font-weight: 700;
            }

            HorizontalBox {
                spacing: 10px;

                Button {
                    text: @tr("Refresh");
                    min-width: 100px;
                    height: 35px;
                    clicked => {
                        root.load-titles();
                    }
                }

                Button {
                    text: @tr("+ New Title");
                    primary: true;
                    min-width: 150px;
                    height: 35px;
                    clicked => {
                        root.show-create-dialog = true;
                        root.new-title = "";
                        root.new-subtitle = "";
                        root.new-isbn = "";
                        root.new-publisher = "";
                        root.new-publication-year = "";
                        root.new-pages = "";
                        root.new-language = "fr";
                        root.new-genre-index = -1;
                        root.new-genre-id = "";
                        root.new-series-index = -1;
                        root.new-series-id = "";
                        root.new-series-number = "";
                        root.new-dewey-code = "";
                        root.new-summary = "";
                    }
                }

                Button {
                    text: @tr("ðŸ” Find Duplicates");
                    min-width: 160px;
                    height: 35px;
                    clicked => {
                        root.find-duplicates();
                    }
                }
            }
        }

        // Search/Filter Panel (Collapsible)
        Rectangle {
            background: #f8f9fa;
            border-width: 1px;
            border-color: #ddd;
            border-radius: 6px;

            VerticalBox {
                padding: 15px;
                spacing: 10px;

                // Filter toggle header
                HorizontalBox {
                    spacing: 10px;
                    height: 40px;

                    Button {
                        text: root.show-filters ? @tr("â–¼ Hide Filters") : @tr("â–¶ Show Filters");
                        min-width: 140px;
                        height: 35px;
                        clicked => {
                            root.show-filters = !root.show-filters;
                        }
                    }

                    if root.show-filters: Button {
                        text: @tr("Clear All Filters");
                        min-width: 140px;
                        height: 35px;
                        clicked => {
                            root.filter-search-text = "";
                            root.filter-title = "";
                            root.filter-subtitle = "";
                            root.filter-isbn = "";
                            root.filter-series-index = -1;
                            root.filter-author-index = -1;
                            root.filter-genre-index = -1;
                            root.filter-publisher-index = -1;
                            root.filter-year-from = "";
                            root.filter-year-to = "";
                            root.filter-language = "";
                            root.filter-dewey-code = "";
                            root.filter-has-volumes = false;
                            root.filter-wishlist-only = false;
                            root.filter-available-only = false;
                            root.filter-location-index = -1;
                            root.show-advanced-filters = false;
                            root.load-titles();  // Load all titles without filters
                        }
                    }

                    if root.show-filters: Button {
                        text: @tr("Search");
                        primary: true;
                        min-width: 120px;
                        height: 35px;
                        clicked => {
                            // Convert indices to IDs
                            root.search-titles(
                                root.filter-search-text,
                                root.filter-title,
                                root.filter-subtitle,
                                root.filter-isbn,
                                (root.filter-series-index >= 0 && root.filter-series-index < root.series-list.length) ? root.series-list[root.filter-series-index].id : "",
                                (root.filter-author-index >= 0 && root.filter-author-index < root.all-authors.length) ? root.all-authors[root.filter-author-index].id : "",
                                (root.filter-genre-index >= 0 && root.filter-genre-index < root.genres.length) ? root.genres[root.filter-genre-index].id : "",
                                (root.filter-publisher-index > 0 && root.filter-publisher-index <= root.publishers.length) ? root.publishers[root.filter-publisher-index - 1].id : "",
                                root.filter-year-from,
                                root.filter-year-to,
                                root.filter-language,
                                root.filter-dewey-code,
                                root.filter-has-volumes,
                                root.filter-wishlist-only,
                                root.filter-available-only,
                                (root.filter-location-index > 0 && root.filter-location-index <= root.locations.length) ? root.locations[root.filter-location-index - 1].id : "");
                        }
                    }
                }

                // Filter fields (visible when show-filters is true)
                if root.show-filters: VerticalBox {
                    spacing: 12px;

                    // Basic Filters Section
                    Rectangle {
                        background: white;
                        border-width: 1px;
                        border-color: #e0e0e0;
                        border-radius: 4px;

                        VerticalBox {
                            padding: 15px;
                            spacing: 10px;

                            Text {
                                text: @tr("Basic Filters");
                                font-size: 14px;
                                font-weight: 600;
                                color: #333;
                            }

                            // Free text search
                            HorizontalBox {
                                spacing: 10px;
                                Text {
                                    text: @tr("Search:");
                                    width: 120px;
                                    vertical-alignment: center;
                                }

                                LineEdit {
                                    text <=> root.filter-search-text;
                                    placeholder-text: @tr("Search title, subtitle, author, ISBN...");
                                }
                            }

                            // Series filter
                            HorizontalBox {
                                spacing: 10px;
                                Text {
                                    text: @tr("Series:");
                                    width: 120px;
                                    vertical-alignment: center;
                                }

                                ComboBox {
                                    model: root.series-names;
                                    current-index <=> root.filter-series-index;
                                }
                            }

                            // Author filter
                            HorizontalBox {
                                spacing: 10px;
                                Text {
                                    text: @tr("Author:");
                                    width: 120px;
                                    vertical-alignment: center;
                                }

                                ComboBox {
                                    model: root.author-names;
                                    current-index <=> root.filter-author-index;
                                }
                            }

                            // Genre filter
                            HorizontalBox {
                                spacing: 10px;
                                Text {
                                    text: @tr("Genre:");
                                    width: 120px;
                                    vertical-alignment: center;
                                }

                                ComboBox {
                                    model: root.genre-names;
                                    current-index <=> root.filter-genre-index;
                                }
                            }

                            // Publisher filter
                            HorizontalBox {
                                spacing: 10px;
                                Text {
                                    text: @tr("Publisher:");
                                    width: 120px;
                                    vertical-alignment: center;
                                }

                                ComboBox {
                                    model: root.publisher-names;
                                    current-index <=> root.filter-publisher-index;
                                }
                            }
                        }
                    }

                    // Advanced Filters Toggle
                    Button {
                        text: root.show-advanced-filters ? @tr("â–¼ Hide Advanced Filters") : @tr("â–¶ Show Advanced Filters");
                        min-width: 200px;
                        height: 32px;
                        clicked => {
                            root.show-advanced-filters = !root.show-advanced-filters;
                        }
                    }

                    // Advanced Filters Section
                    if root.show-advanced-filters: Rectangle {
                        background: white;
                        border-width: 1px;
                        border-color: #e0e0e0;
                        border-radius: 4px;

                        VerticalBox {
                            padding: 15px;
                            spacing: 10px;

                            Text {
                                text: @tr("Advanced Filters");
                                font-size: 14px;
                                font-weight: 600;
                                color: #333;
                            }

                            // Title filter
                            HorizontalBox {
                                spacing: 10px;
                                Text {
                                    text: @tr("Title contains:");
                                    width: 120px;
                                    vertical-alignment: center;
                                }

                                LineEdit {
                                    text <=> root.filter-title;
                                    placeholder-text: @tr("Partial title match...");
                                }
                            }

                            // Subtitle filter
                            HorizontalBox {
                                spacing: 10px;
                                Text {
                                    text: @tr("Subtitle:");
                                    width: 120px;
                                    vertical-alignment: center;
                                }

                                LineEdit {
                                    text <=> root.filter-subtitle;
                                    placeholder-text: @tr("Partial subtitle match...");
                                }
                            }

                            // ISBN filter
                            HorizontalBox {
                                spacing: 10px;
                                Text {
                                    text: @tr("ISBN:");
                                    width: 120px;
                                    vertical-alignment: center;
                                }

                                LineEdit {
                                    text <=> root.filter-isbn;
                                    placeholder-text: @tr("Full or partial ISBN...");
                                }
                            }

                            // Year range
                            HorizontalBox {
                                spacing: 10px;
                                Text {
                                    text: @tr("Year:");
                                    width: 120px;
                                    vertical-alignment: center;
                                }

                                Text {
                                    text: @tr("From");
                                    width: 40px;
                                    vertical-alignment: center;
                                }

                                LineEdit {
                                    text <=> root.filter-year-from;
                                    placeholder-text: @tr("2000");
                                    width: 100px;
                                }

                                Text {
                                    text: @tr("To");
                                    width: 30px;
                                    vertical-alignment: center;
                                }

                                LineEdit {
                                    text <=> root.filter-year-to;
                                    placeholder-text: @tr("2024");
                                    width: 100px;
                                }
                            }

                            // Language filter
                            HorizontalBox {
                                spacing: 10px;
                                Text {
                                    text: @tr("Language:");
                                    width: 120px;
                                    vertical-alignment: center;
                                }

                                LineEdit {
                                    text <=> root.filter-language;
                                    placeholder-text: @tr("e.g., en, fr, es");
                                }
                            }

                            // Dewey code filter
                            HorizontalBox {
                                spacing: 10px;
                                Text {
                                    text: @tr("Dewey Code:");
                                    width: 120px;
                                    vertical-alignment: center;
                                }

                                LineEdit {
                                    text <=> root.filter-dewey-code;
                                    placeholder-text: @tr("e.g., 800 (Literature)");
                                }
                            }

                            // Location filter
                            HorizontalBox {
                                spacing: 10px;
                                Text {
                                    text: @tr("Location:");
                                    width: 120px;
                                    vertical-alignment: center;
                                }

                                ComboBox {
                                    model: root.location-names;
                                    current-index <=> root.filter-location-index;
                                }
                            }

                            // Ownership status checkboxes
                            HorizontalBox {
                                spacing: 20px;
                                Text {
                                    text: @tr("Show:");
                                    width: 120px;
                                    vertical-alignment: center;
                                }

                                HorizontalBox {
                                    spacing: 15px;

                                    Rectangle {
                                        width: 20px;
                                        height: 20px;
                                        border-width: 2px;
                                        border-color: #0066cc;
                                        border-radius: 3px;
                                        background: root.filter-has-volumes ? #0066cc : white;

                                        TouchArea {
                                            clicked => {
                                                root.filter-has-volumes = !root.filter-has-volumes;
                                                if (root.filter-has-volumes) {
                                                    root.filter-wishlist-only = false;
                                                }
                                            }
                                        }
                                    }

                                    Text {
                                        text: @tr("Owned (has volumes)");
                                        font-size: 13px;
                                        vertical-alignment: center;
                                    }

                                    Rectangle {
                                        width: 20px;
                                        height: 20px;
                                        border-width: 2px;
                                        border-color: #0066cc;
                                        border-radius: 3px;
                                        background: root.filter-wishlist-only ? #0066cc : white;

                                        TouchArea {
                                            clicked => {
                                                root.filter-wishlist-only = !root.filter-wishlist-only;
                                                if (root.filter-wishlist-only) {
                                                    root.filter-has-volumes = false;
                                                    root.filter-available-only = false;
                                                }
                                            }
                                        }
                                    }

                                    Text {
                                        text: @tr("Wishlist only");
                                        font-size: 13px;
                                        vertical-alignment: center;
                                    }

                                    Rectangle {
                                        width: 20px;
                                        height: 20px;
                                        border-width: 2px;
                                        border-color: #0066cc;
                                        border-radius: 3px;
                                        background: root.filter-available-only ? #0066cc : white;

                                        TouchArea {
                                            clicked => {
                                                root.filter-available-only = !root.filter-available-only;
                                                if (root.filter-available-only) {
                                                    root.filter-wishlist-only = false;
                                                }
                                            }
                                        }
                                    }

                                    Text {
                                        text: @tr("Available for loan");
                                        font-size: 13px;
                                        vertical-alignment: center;
                                    }
                                }
                            }
                        }
                    }

                    // Duplicate Filters Section (visible when duplicates have been detected)
                    if root.duplicates-detected: Rectangle {
                        background: #fff8e6;
                        border-width: 1px;
                        border-color: #ffb84d;
                        border-radius: 4px;

                        VerticalBox {
                            padding: 15px;
                            spacing: 10px;

                            HorizontalBox {
                                spacing: 10px;
                                alignment: space-between;

                                Text {
                                    text: @tr("ðŸ” Duplicate Filters");
                                    font-size: 14px;
                                    font-weight: 600;
                                    color: #cc6600;
                                }

                                Button {
                                    text: @tr("Clear Duplicates");
                                    min-width: 120px;
                                    height: 28px;
                                    clicked => {
                                        root.clear-duplicates();
                                    }
                                }
                            }

                            HorizontalBox {
                                spacing: 20px;

                                // Show only duplicates checkbox
                                HorizontalBox {
                                    spacing: 8px;

                                    Rectangle {
                                        width: 20px;
                                        height: 20px;
                                        border-width: 2px;
                                        border-color: #cc6600;
                                        border-radius: 3px;
                                        background: root.filter-show-only-duplicates ? #cc6600 : white;

                                        TouchArea {
                                            clicked => {
                                                root.filter-show-only-duplicates = !root.filter-show-only-duplicates;
                                            }
                                        }
                                    }

                                    Text {
                                        text: @tr("Show only duplicates");
                                        font-size: 13px;
                                        font-weight: 600;
                                        vertical-alignment: center;
                                    }
                                }
                            }

                            // Confidence level filters
                            HorizontalBox {
                                spacing: 20px;

                                Text {
                                    text: @tr("Confidence:");
                                    font-size: 13px;
                                    font-weight: 600;
                                    vertical-alignment: center;
                                    width: 90px;
                                }

                                HorizontalBox {
                                    spacing: 15px;

                                    // High confidence
                                    Rectangle {
                                        width: 20px;
                                        height: 20px;
                                        border-width: 2px;
                                        border-color: #cc0000;
                                        border-radius: 3px;
                                        background: root.filter-duplicates-high ? #cc0000 : white;

                                        TouchArea {
                                            clicked => {
                                                root.filter-duplicates-high = !root.filter-duplicates-high;
                                            }
                                        }
                                    }

                                    Text {
                                        text: @tr("High");
                                        font-size: 13px;
                                        color: #cc0000;
                                        font-weight: 600;
                                        vertical-alignment: center;
                                    }

                                    // Medium confidence
                                    Rectangle {
                                        width: 20px;
                                        height: 20px;
                                        border-width: 2px;
                                        border-color: #ff8800;
                                        border-radius: 3px;
                                        background: root.filter-duplicates-medium ? #ff8800 : white;

                                        TouchArea {
                                            clicked => {
                                                root.filter-duplicates-medium = !root.filter-duplicates-medium;
                                            }
                                        }
                                    }

                                    Text {
                                        text: @tr("Medium");
                                        font-size: 13px;
                                        color: #ff8800;
                                        font-weight: 600;
                                        vertical-alignment: center;
                                    }

                                    // Low confidence
                                    Rectangle {
                                        width: 20px;
                                        height: 20px;
                                        border-width: 2px;
                                        border-color: #0088cc;
                                        border-radius: 3px;
                                        background: root.filter-duplicates-low ? #0088cc : white;

                                        TouchArea {
                                            clicked => {
                                                root.filter-duplicates-low = !root.filter-duplicates-low;
                                            }
                                        }
                                    }

                                    Text {
                                        text: @tr("Low");
                                        font-size: 13px;
                                        color: #0088cc;
                                        font-weight: 600;
                                        vertical-alignment: center;
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }

        // Create title dialog
        if show-create-dialog: Rectangle {
            background: white;
            border-width: 2px;
            border-color: #0066cc;
            border-radius: 8px;
            //height: 750px; // Remove this to allow automatic vertical adjustment

            VerticalBox {
                padding: 20px;
                spacing: 12px;

                Text {
                    text: @tr("Create New Title");
                    font-size: 18px;
                    font-weight: 600;
                }

                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: @tr("Title:");
                        width: 120px;
                        vertical-alignment: center;
                    }

                    LineEdit {
                        text <=> root.new-title;
                        placeholder-text: @tr("Title (required)");
                    }
                }

                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: @tr("Subtitle:");
                        width: 120px;
                        vertical-alignment: center;
                    }

                    LineEdit {
                        text <=> root.new-subtitle;
                        placeholder-text: @tr("Subtitle (optional)");
                    }
                }

                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: @tr("ISBN:");
                        width: 120px;
                        vertical-alignment: center;
                    }

                    LineEdit {
                        text <=> root.new-isbn;
                        placeholder-text: @tr("ISBN-13 or ISBN-10");
                    }

                    Button {
                        text: @tr("Fetch from ISBN");
                        enabled: root.new-isbn != "";
                        clicked => {
                            root.fetch-from-isbn(root.new-isbn);
                        }
                    }
                }

                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: @tr("Publisher:");
                        width: 120px;
                        vertical-alignment: center;
                    }

                    ComboBox {
                        model: root.publisher-names;
                        current-index <=> root.new-publisher-index;
                    }
                }

                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: @tr("Pub. Year:");
                        width: 120px;
                        vertical-alignment: center;
                    }

                    LineEdit {
                        text <=> root.new-publication-year;
                        placeholder-text: @tr("E.g., 2024");
                    }
                }

                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: @tr("Pages:");
                        width: 120px;
                        vertical-alignment: center;
                    }

                    LineEdit {
                        text <=> root.new-pages;
                        placeholder-text: @tr("Number of pages");
                    }
                }

                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: @tr("Language:");
                        width: 120px;
                        vertical-alignment: center;
                    }

                    LineEdit {
                        text <=> root.new-language;
                        placeholder-text: @tr("E.g., fr, en, es");
                    }
                }

                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: @tr("Genre:");
                        width: 120px;
                        vertical-alignment: center;
                    }

                    ComboBox {
                        model: root.genre-names;
                        current-index <=> root.new-genre-index;
                    }
                }

                // Series selection
                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: @tr("Series:");
                        width: 120px;
                        vertical-alignment: center;
                    }

                    ComboBox {
                        model: root.series-names;
                        current-index <=> root.new-series-index;
                    }
                }

                // Dewey Classification
                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: @tr("Dewey Code:");
                        width: 120px;
                        vertical-alignment: center;
                    }

                    LineEdit {
                        text <=> root.new-dewey-code;
                        placeholder-text: @tr("E.g., 635.048");
                    }
                }

                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: @tr("Summary:");
                        width: 120px;
                        vertical-alignment: top;
                    }

                    TextEdit {
                        text <=> root.new-summary;
                        height: 100px;
                    }
                }

                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: @tr("Cover URL:");
                        width: 120px;
                        vertical-alignment: center;
                    }

                    LineEdit {
                        text <=> root.new-cover-url;
                        placeholder-text: @tr("https://example.com/cover.jpg");
                    }
                }

                HorizontalBox {
                    spacing: 10px;
                    alignment: end;

                    Button {
                        text: @tr("Cancel");
                        min-width: 100px;
                        height: 35px;
                        clicked => {
                            root.show-create-dialog = false;
                        }
                    }

                    Button {
                        text: @tr("Save");
                        primary: true;
                        min-width: 100px;
                        height: 35px;
                        enabled: root.new-title != "";
                        clicked => {
                            // Look up publisher_id from index
                            root.new-publisher-id = (root.new-publisher-index > 0 && root.new-publisher-index <= root.publishers.length) ? root.publishers[root.new-publisher-index - 1].id : "";

                            // Look up genre_id and series_id from indices
                            root.new-genre-id = (root.new-genre-index >= 0 && root.new-genre-index < root.genres.length) ? root.genres[root.new-genre-index].id : "";
                            root.new-series-id = (root.new-series-index >= 0 && root.new-series-index < root.series-list.length) ? root.series-list[root.new-series-index].id : "";

                            root.create-title(
                                root.new-title,
                                root.new-subtitle,
                                root.new-isbn,
                                root.new-publisher,
                                root.new-publisher-id,
                                root.new-publication-year,
                                root.new-pages,
                                root.new-language,
                                root.new-genre-id,
                                root.new-series-id,
                                "",
                                root.new-summary,
                                root.new-cover-url,
                                root.new-dewey-code);
                            root.show-create-dialog = false;
                        }
                    }
                }
            }
        }

        // Edit title dialog
        if show-edit-dialog: Rectangle {
            background: white;
            border-width: 2px;
            border-color: #0066cc;
            border-radius: 8px;

            VerticalBox {
                padding: 20px;
                spacing: 12px;

                Text {
                    text: @tr("Edit Title");
                    font-size: 18px;
                    font-weight: 600;
                }

                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: @tr("Title:");
                        width: 120px;
                        vertical-alignment: center;
                    }

                    LineEdit {
                        text <=> root.edit-title;
                        placeholder-text: @tr("Title (required)");
                    }
                }

                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: @tr("Subtitle:");
                        width: 120px;
                        vertical-alignment: center;
                    }

                    LineEdit {
                        text <=> root.edit-subtitle;
                        placeholder-text: @tr("Subtitle (optional)");
                    }
                }

                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: @tr("ISBN:");
                        width: 120px;
                        vertical-alignment: center;
                    }

                    LineEdit {
                        text <=> root.edit-isbn;
                        placeholder-text: @tr("ISBN-13 or ISBN-10");
                    }

                    Button {
                        text: @tr("Fetch from ISBN");
                        enabled: root.edit-isbn != "";
                        clicked => {
                            root.fetch-from-isbn-edit(root.edit-isbn);
                        }
                    }
                }

                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: @tr("Publisher:");
                        width: 120px;
                        vertical-alignment: center;
                    }

                    ComboBox {
                        model: root.publisher-names;
                        current-index <=> root.edit-publisher-index;
                    }
                }

                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: @tr("Pub. Year:");
                        width: 120px;
                        vertical-alignment: center;
                    }

                    LineEdit {
                        text <=> root.edit-publication-year;
                        placeholder-text: @tr("E.g., 2024");
                    }
                }

                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: @tr("Pages:");
                        width: 120px;
                        vertical-alignment: center;
                    }

                    LineEdit {
                        text <=> root.edit-pages;
                        placeholder-text: @tr("Number of pages");
                    }
                }

                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: @tr("Language:");
                        width: 120px;
                        vertical-alignment: center;
                    }

                    LineEdit {
                        text <=> root.edit-language;
                        placeholder-text: @tr("E.g., fr, en, es");
                    }
                }

                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: @tr("Genre:");
                        width: 120px;
                        vertical-alignment: center;
                    }

                    ComboBox {
                        model: root.genre-names;
                        current-index <=> root.edit-genre-index;
                    }
                }

                // Series selection (Edit)
                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: @tr("Series:");
                        width: 120px;
                        vertical-alignment: center;
                    }

                    ComboBox {
                        model: root.series-names;
                        current-index <=> root.edit-series-index;
                    }
                }

                // Dewey Classification (Edit)
                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: @tr("Dewey Code:");
                        width: 120px;
                        vertical-alignment: center;
                    }

                    LineEdit {
                        text <=> root.edit-dewey-code;
                        placeholder-text: @tr("E.g., 635.048");
                    }
                }

                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: @tr("Summary:");
                        width: 120px;
                        vertical-alignment: top;
                    }

                    TextEdit {
                        text <=> root.edit-summary;
                        height: 100px;
                    }
                }

                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: @tr("Cover URL:");
                        width: 120px;
                        vertical-alignment: center;
                    }

                    LineEdit {
                        text <=> root.edit-cover-url;
                        placeholder-text: @tr("https://example.com/cover.jpg");
                    }
                }

                HorizontalBox {
                    spacing: 10px;
                    alignment: space-between;

                    Button {
                        text: @tr("Manage Authors");
                        min-width: 150px;
                        height: 35px;
                        clicked => {
                            root.managing-authors-title-id = root.edit-id;
                            root.load-title-authors(root.edit-id);
                            root.load-all-authors();
                            root.show-authors-dialog = true;
                        }
                    }

                    HorizontalBox {
                        spacing: 10px;

                        Button {
                            text: @tr("Cancel");
                            min-width: 100px;
                            height: 35px;
                            clicked => {
                                root.show-edit-dialog = false;
                            }
                        }

                        Button {
                            text: @tr("Save");
                            primary: true;
                            min-width: 100px;
                            height: 35px;
                            enabled: root.edit-title != "";
                            clicked => {
                            // Look up publisher_id from index
                            root.edit-publisher-id = (root.edit-publisher-index > 0 && root.edit-publisher-index <= root.publishers.length) ? root.publishers[root.edit-publisher-index - 1].id : "";

                            // Look up genre_id and series_id from indices
                            root.edit-genre-id = (root.edit-genre-index >= 0 && root.edit-genre-index < root.genres.length) ? root.genres[root.edit-genre-index].id : "";
                                root.edit-series-id = (root.edit-series-index >= 0 && root.edit-series-index < root.series-list.length) ? root.series-list[root.edit-series-index].id : "";

                                root.update-title(
                                root.edit-id,
                                root.edit-title,
                                root.edit-subtitle,
                                root.edit-isbn,
                                root.edit-publisher,
                                root.edit-publisher-id,
                                root.edit-publication-year,
                                root.edit-pages,
                                root.edit-language,
                                root.edit-genre-id,
                                root.edit-series-id,
                                "",
                                root.edit-summary,
                                root.edit-cover-url,
                                root.edit-dewey-code);
                                root.show-edit-dialog = false;
                            }
                        }
                    }
                }
            }
        }

        // Delete confirmation dialog
        if show-delete-confirmation: Rectangle {
            background: white;
            border-width: 2px;
            border-color: #cc0000;
            border-radius: 8px;
            width: 500px;
            height: 200px;

            VerticalBox {
                padding: 20px;
                spacing: 20px;

                Text {
                    text: @tr("Delete Title?");
                    font-size: 18px;
                    font-weight: 600;
                    color: #cc0000;
                }

                Text {
                    text: @tr("Are you sure you want to delete this title?\n\n") + "\"" + root.delete-title-name + "\"";
                    font-size: 14px;
                    color: #333;
                    wrap: word-wrap;
                }

                HorizontalBox {
                    spacing: 10px;
                    alignment: end;

                    Button {
                        text: @tr("Cancel");
                        min-width: 100px;
                        height: 35px;
                        clicked => {
                            root.show-delete-confirmation = false;
                        }
                    }

                    Button {
                        text: @tr("Delete");
                        primary: true;
                        min-width: 100px;
                        height: 35px;
                        clicked => {
                            root.delete-title(root.delete-title-id);
                            root.show-delete-confirmation = false;
                        }
                    }
                }
            }
        }

        // Volume creation dialog
        if show-volume-create-dialog: Rectangle {
            background: white;
            border-width: 2px;
            border-color: #0066cc;
            border-radius: 8px;
            width: 600px;
            height: 450px;

            VerticalBox {
                padding: 20px;
                spacing: 15px;

                Text {
                    text: @tr("Add New Volume");
                    font-size: 18px;
                    font-weight: 600;
                }

                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: @tr("Barcode:");
                        width: 120px;
                        vertical-alignment: center;
                    }

                    LineEdit {
                        text <=> root.volume-barcode;
                        placeholder-text: @tr("123456");
                    }
                }

                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: @tr("Condition:");
                        width: 120px;
                        vertical-alignment: center;
                    }

                    ComboBox {
                        model: ["Excellent", "Good", "Fair", "Poor", "Damaged"];
                        current-value <=> root.volume-condition;
                    }
                }

                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: @tr("Location:");
                        width: 120px;
                        vertical-alignment: center;
                    }

                    ComboBox {
                        model: root.location-names;
                        current-index <=> root.volume-location-index;
                    }
                }

                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: @tr("Notes:");
                        width: 120px;
                        vertical-alignment: top;
                    }

                    TextEdit {
                        text <=> root.volume-notes;
                        height: 80px;
                    }
                }

                HorizontalBox {
                    spacing: 10px;
                    alignment: end;

                    Button {
                        text: @tr("Cancel");
                        min-width: 100px;
                        height: 35px;
                        clicked => {
                            root.show-volume-create-dialog = false;
                            root.volume-create-error = "";
                        }
                    }

                    Button {
                        text: @tr("Create");
                        primary: true;
                        min-width: 100px;
                        height: 35px;
                        enabled: root.volume-barcode != "";
                        clicked => {
                            root.volume-create-error = "";
                            // Convert location index to location ID
                            // Index 0 = "(No location)" so we subtract 1 for actual locations
                            root.create-volume(
                                root.volume-create-title-id,
                                root.volume-barcode,
                                root.volume-condition,
                                root.volume-location-index > 0 ? root.locations[root.volume-location-index - 1].id : "",
                                root.volume-notes);
                            // Do not close dialog immediately - wait for success
                            // root.show-volume-create-dialog = false;
                        }
                    }
                }
            }
        }

        // Volume delete confirmation dialog
        if show-volume-delete-confirmation: Rectangle {
            background: white;
            border-width: 2px;
            border-color: #cc0000;
            border-radius: 8px;
            width: 500px;
            height: 200px;

            VerticalBox {
                padding: 20px;
                spacing: 20px;

                Text {
                    text: @tr("Delete Volume?");
                    font-size: 18px;
                    font-weight: 600;
                    color: #cc0000;
                }

                Text {
                    text: @tr("Are you sure you want to delete this volume?\n\nBarcode: ") + root.delete-volume-barcode;
                    font-size: 14px;
                    color: #333;
                    wrap: word-wrap;
                }

                HorizontalBox {
                    spacing: 10px;
                    alignment: end;

                    Button {
                        text: @tr("Cancel");
                        min-width: 100px;
                        height: 35px;
                        clicked => {
                            root.show-volume-delete-confirmation = false;
                        }
                    }

                    Button {
                        text: @tr("Delete");
                        primary: true;
                        min-width: 100px;
                        height: 35px;
                        clicked => {
                            root.delete-volume(root.delete-volume-id);
                            root.show-volume-delete-confirmation = false;
                        }
                    }
                }
            }
        }

        // Volume edit dialog
        if show-volume-edit-dialog: Rectangle {
            background: white;
            border-width: 2px;
            border-color: #0066cc;
            border-radius: 8px;
            width: 600px;
            height: 450px;

            VerticalBox {
                padding: 20px;
                spacing: 15px;

                Text {
                    text: @tr("Edit Volume");
                    font-size: 18px;
                    font-weight: 600;
                }

                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: @tr("Barcode:");
                        width: 120px;
                        vertical-alignment: center;
                    }

                    LineEdit {
                        text <=> root.edit-volume-barcode;
                        placeholder-text: @tr("123456");
                    }
                }

                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: @tr("Condition:");
                        width: 120px;
                        vertical-alignment: center;
                    }

                    ComboBox {
                        model: ["Excellent", "Good", "Fair", "Poor", "Damaged"];
                        current-value <=> root.edit-volume-condition;
                    }
                }

                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: @tr("Location:");
                        width: 120px;
                        vertical-alignment: center;
                    }

                    ComboBox {
                        model: root.location-names;
                        current-index <=> root.edit-volume-location-index;
                    }
                }

                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: @tr("Notes:");
                        width: 120px;
                        vertical-alignment: top;
                    }

                    TextEdit {
                        text <=> root.edit-volume-notes;
                        height: 80px;
                    }
                }

                HorizontalBox {
                    spacing: 10px;
                    alignment: end;

                    Button {
                        text: @tr("Cancel");
                        min-width: 100px;
                        height: 35px;
                        clicked => {
                            root.show-volume-edit-dialog = false;
                        }
                    }

                    Button {
                        text: @tr("Save");
                        primary: true;
                        min-width: 100px;
                        height: 35px;
                        enabled: root.edit-volume-barcode != "";
                        clicked => {
                            // Convert location index to location ID
                            root.update-volume(
                                root.edit-volume-id,
                                root.edit-volume-barcode,
                                root.edit-volume-condition,
                                root.edit-volume-location-index > 0 ? root.locations[root.edit-volume-location-index - 1].id : "",
                                root.edit-volume-notes);
                            root.show-volume-edit-dialog = false;
                        }
                    }
                }
            }
        }

        // Authors management dialog
        if show-authors-dialog: Rectangle {
            background: white;
            border-width: 2px;
            border-color: #0066cc;
            border-radius: 8px;
            width: 700px;
            height: 600px;

            VerticalBox {
                padding: 20px;
                spacing: 15px;

                Text {
                    text: @tr("Manage Authors");
                    font-size: 18px;
                    font-weight: 600;
                }

                // Current authors list
                Text {
                    text: @tr("Current Authors:");
                    font-size: 14px;
                    font-weight: 600;
                }

                if root.title-authors.length == 0: Text {
                    text: @tr("No authors assigned yet");
                    font-size: 13px;
                    color: #888;
                    height: 40px;
                }

                if root.title-authors.length > 0: ScrollView {
                    height: 200px;

                    VerticalBox {
                        spacing: 5px;

                        for author in root.title-authors: Rectangle {
                            height: 40px;
                            border-width: 1px;
                            border-color: #ddd;
                            border-radius: 4px;
                            background: #fafafa;

                            HorizontalBox {
                                padding: 8px;
                                spacing: 10px;

                                Text {
                                    text: author.first-name + " " + author.last-name;
                                    font-size: 14px;
                                    font-weight: 600;
                                    horizontal-stretch: 1;
                                    vertical-alignment: center;
                                }

                                Text {
                                    text: author.role == "main_author" ? @tr("Main Author") : author.role == "co_author" ? @tr("Co-Author") : author.role == "translator" ? @tr("Translator") : author.role == "illustrator" ? @tr("Illustrator") : author.role == "editor" ? @tr("Editor") : author.role;
                                    font-size: 12px;
                                    color: #0066cc;
                                    vertical-alignment: center;
                                }

                                Button {
                                    text: @tr("Remove");
                                    min-width: 80px;
                                    height: 28px;
                                    clicked => {
                                        root.remove-author-from-title(root.managing-authors-title-id, author.author-id);
                                    }
                                }
                            }
                        }
                    }
                }

                Rectangle {
                    height: 2px;
                    background: #ddd;
                }

                // Add new author section
                Text {
                    text: @tr("Add Author:");
                    font-size: 14px;
                    font-weight: 600;
                }

                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: @tr("Author:");
                        width: 80px;
                        vertical-alignment: center;
                    }

                    ComboBox {
                        model: root.author-names;
                        current-index <=> root.add-author-index;
                    }
                }

                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: @tr("Role:");
                        width: 80px;
                        vertical-alignment: center;
                    }

                    ComboBox {
                        model: root.role-names;
                        current-index <=> root.add-author-role-index;
                    }
                }

                HorizontalBox {
                    spacing: 10px;
                    alignment: center;

                    Button {
                        text: @tr("Add Author");
                        primary: true;
                        min-width: 150px;
                        height: 35px;
                        enabled: root.add-author-index >= 0 && root.all-authors.length > 0;
                        clicked => {
                            // Convert role index to role string
                            root.add-author-to-title(
                                root.managing-authors-title-id,
                                root.all-authors[root.add-author-index].id,
                                root.add-author-role-index == 0 ? "main_author" : root.add-author-role-index == 1 ? "co_author" : root.add-author-role-index == 2 ? "translator" : root.add-author-role-index == 3 ? "illustrator" : "editor");
                        }
                    }
                }

                HorizontalBox {
                    spacing: 10px;
                    alignment: end;

                    Button {
                        text: @tr("Close");
                        min-width: 100px;
                        height: 35px;
                        clicked => {
                            root.show-authors-dialog = false;
                            root.title-authors = [];
                        }
                    }
                }
            }
        }

        // List of titles
        if titles.length == 0 && !show-create-dialog && !show-edit-dialog && !show-delete-confirmation: Text {
            text: @tr("No titles found. Click Refresh to load titles from the backend.");
            color: #888;
        }

        if titles.length > 0: ListView {
            for title[index] in titles: VerticalBox {
                spacing: 0px;

                // Title row
                Rectangle {
                    height: 80px;
                    border-width: title.is-duplicate ? 3px : 1px;
                    border-color: title.is-duplicate ? (title.duplicate-confidence == "High" ? #cc0000 : title.duplicate-confidence == "Medium" ? #ff8800 : #0088cc) : #ddd;
                    border-radius: 4px;
                    background: title.is-duplicate ? #fffaef : (Math.mod(index, 2) == 0 ? #fafafa : white);

                    HorizontalLayout {
                        padding: 8px;
                        spacing: 10px;

                        VerticalLayout {
                            alignment: start;
                            spacing: 4px;

                            HorizontalBox {
                                spacing: 8px;

                                Text {
                                    text: title.title;
                                    font-size: 15px;
                                    font-weight: 600;
                                    overflow: elide;
                                }

                                // Duplicate badge
                                if title.is-duplicate: Rectangle {
                                    width: 65px;
                                    height: 20px;
                                    border-radius: 10px;
                                    background: title.duplicate-confidence == "High" ? #cc0000 : title.duplicate-confidence == "Medium" ? #ff8800 : #0088cc;

                                    Text {
                                        text: "âš  " + (title.duplicate-confidence == "High" ? @tr("HIGH") : title.duplicate-confidence == "Medium" ? @tr("MED") : @tr("LOW"));
                                        font-size: 10px;
                                        font-weight: 700;
                                        color: white;
                                        horizontal-alignment: center;
                                        vertical-alignment: center;
                                    }
                                }

                                // Primary/Secondary indicator
                                if title.is-duplicate: Rectangle {
                                    width: 55px;
                                    height: 20px;
                                    border-radius: 10px;
                                    background: title.is-duplicate-primary ? #00aa00 : #888888;

                                    Text {
                                        text: title.is-duplicate-primary ? @tr("PRIMARY") : @tr("SECOND");
                                        font-size: 9px;
                                        font-weight: 700;
                                        color: white;
                                        horizontal-alignment: center;
                                        vertical-alignment: center;
                                    }
                                }
                            }

                            if title.subtitle != "": Text {
                                text: title.subtitle;
                                font-size: 13px;
                                color: #666;
                                overflow: elide;
                            }

                            HorizontalBox {
                                spacing: 15px;

                                if title.isbn != "": Text {
                                    text: @tr("ISBN:") + " " + title.isbn;
                                    font-size: 11px;
                                    color: #888;
                                }

                                if title.publisher != "": Text {
                                    text: title.publisher;
                                    font-size: 11px;
                                    color: #888;
                                    overflow: elide;
                                }

                                if title.series-name != "": Text {
                                    text: title.series-name;
                                    font-size: 11px;
                                    color: #8800cc;
                                    font-weight: 600;
                                    overflow: elide;
                                }

                                Text {
                                    text: @tr("Volumes:") + " " + title.volume-count;
                                    font-size: 11px;
                                    color: #0066cc;
                                    font-weight: 600;
                                }

                                Text {
                                    text: title.language;
                                    font-size: 11px;
                                    color: #888;
                                }

                                // Duplicate similarity score
                                if title.is-duplicate: Text {
                                    text: @tr("Similarity:") + " " + Math.round(title.duplicate-similarity) + "%";
                                    font-size: 11px;
                                    color: title.duplicate-confidence == "High" ? #cc0000 : title.duplicate-confidence == "Medium" ? #ff8800 : #0088cc;
                                    font-weight: 700;
                                }
                            }

                            // Match reasons (shown on second line for duplicates)
                            if title.is-duplicate && title.duplicate-match-reasons != "": HorizontalBox {
                                spacing: 8px;

                                Text {
                                    text: @tr("Match:") + " " + title.duplicate-match-reasons;
                                    font-size: 10px;
                                    color: #666;
                                    overflow: elide;
                                }
                            }
                        }

                        VerticalLayout {
                            alignment: center;
                            spacing: 5px;
                            width: 180px;

                            HorizontalBox {
                                spacing: 5px;

                                Button {
                                    text: @tr("Edit");
                                    //min-width: 80px;
                                    //height: 32px;
                                    width: Styles.small_button_width;
                                    height: Styles.small_button_height;
                                    clicked => {
                                        root.edit-id = title.id;
                                        root.edit-title = title.title;
                                        root.edit-subtitle = title.subtitle;
                                        root.edit-isbn = title.isbn;
                                        root.edit-publisher = title.publisher;
                                        root.edit-publication-year = title.publication-year;
                                        root.edit-pages = title.pages;
                                        root.edit-language = title.language;
                                        root.edit-genre-id = title.genre-id;
                                        root.edit-publisher-id = title.publisher-id;
                                        root.edit-series-id = title.series-id;
                                        // Find the genre index for this genre_id
                                        root.edit-genre-index = root.find-genre-index(title.genre-id);
                                        // Find the publisher index for this publisher_id
                                        root.edit-publisher-index = root.find-publisher-index(title.publisher-id);
                                        // Find the series index for this series_id
                                        root.edit-series-index = root.find-series-index(title.series-id);
                                        root.edit-dewey-code = title.dewey-code;
                                        root.edit-summary = title.summary;
                                        root.show-edit-dialog = true;
                                    }
                                }

                                Button {
                                    text: @tr("Delete");
                                    //min-width: 80px;
                                    //height: 32px;
                                    width: Styles.small_button_width;
                                    height: Styles.small_button_height;
                                    enabled: title.volume-count == 0;
                                    clicked => {
                                        root.delete-title-id = title.id;
                                        root.delete-title-name = title.title;
                                        root.show-delete-confirmation = true;
                                    }
                                }
                            }

                            Button {
                                text: root.expanded-title-id == title.id ? @tr("â–² Hide Volumes") : @tr("â–¼ Show Volumes");
                                min-width: 170px;
                                height: 32px;
                                clicked => {
                                    if (root.expanded-title-id == title.id) {
                                        root.expanded-title-id = "";
                                        root.volumes = [];
                                    } else {
                                        root.expanded-title-id = title.id;
                                        root.load-volumes(title.id);
                                    }
                                }
                            }

                            Button {
                                text: @tr("Authors");
                                min-width: 170px;
                                height: 32px;
                                clicked => {
                                    root.managing-authors-title-id = title.id;
                                    root.load-title-authors(title.id);
                                    root.load-all-authors();
                                    root.show-authors-dialog = true;
                                }
                            }

                            // Duplicate action buttons (only shown for duplicates)
                            if title.is-duplicate && title.is-duplicate-primary: Button {
                                text: @tr("ðŸ”€ Merge");
                                primary: true;
                                min-width: 170px;
                                height: 32px;
                                clicked => {
                                    // Merge: keep this (primary), delete the paired one (secondary)
                                    root.merge-titles(title.id, title.duplicate-pair-id);
                                }
                            }

                            if title.is-duplicate: Button {
                                text: @tr("âœ– Not Duplicate");
                                min-width: 170px;
                                height: 28px;
                                clicked => {
                                    root.dismiss-duplicate(title.id, title.duplicate-pair-id);
                                }
                            }
                        }
                    }
                }

                // Expanded volumes section
                if root.expanded-title-id == title.id: Rectangle {
                    border-width: 1px;
                    border-color: #ccc;
                    background: #f5f5f5;

                    VerticalBox {
                        padding: 10px;
                        spacing: 8px;

                        HorizontalBox {
                            spacing: 10px;
                            alignment: space-between;

                            Text {
                                text: @tr("Volumes for this title:");
                                font-size: 13px;
                                font-weight: 600;
                            }

                            Button {
                                text: @tr("+ Add Volume");
                                primary: true;
                                min-width: 120px;
                                height: 30px;
                                clicked => {
                                    root.volume-create-title-id = title.id;
                                    root.volume-barcode = "";
                                    root.volume-condition = "Good";
                                    root.volume-location-index = 0;  // Default to "(No location)"
                                    root.volume-location-id = "";
                                    root.volume-notes = "";
                                    root.show-volume-create-dialog = true;
                                }
                            }
                        }

                        if root.volumes.length == 0: Text {
                            text: @tr("No volumes found for this title.");
                            font-size: 12px;
                            color: #888;
                        }

                        if root.volumes.length > 0: VerticalBox {
                            spacing: 5px;

                            for volume in root.volumes: Rectangle {
                                height: 80px;
                                background: white;
                                border-width: 1px;
                                border-color: #ddd;
                                border-radius: 3px;

                                HorizontalLayout {
                                    padding: 8px;
                                    spacing: 10px;

                                    VerticalLayout {
                                        alignment: start;
                                        spacing: 3px;

                                        HorizontalBox {
                                            spacing: 15px;

                                            Text {
                                                text: @tr("Copy #") + volume.copy-number;
                                                font-size: 13px;
                                                font-weight: 600;
                                            }

                                            Text {
                                                text: @tr("Barcode:") + " " + volume.barcode;
                                                font-size: 12px;
                                                color: #444;
                                            }

                                            Text {
                                                text: @tr("Condition:") + " " + volume.condition;
                                                font-size: 12px;
                                                color: #666;
                                            }

                                            Text {
                                                text: @tr("Status:") + " " + volume.loan-status;
                                                font-size: 12px;
                                                color: volume.loan-status == "Available" ? #008800 : #cc0000;
                                                font-weight: 600;
                                            }
                                        }

                                        HorizontalBox {
                                            spacing: 15px;

                                            if volume.location-name != "": Text {
                                                text: "ðŸ“ " + volume.location-name;
                                                font-size: 12px;
                                                color: #0066cc;
                                            }
                                        }

                                        if volume.individual-notes != "": Text {
                                            text: @tr("Notes: ") + volume.individual-notes;
                                            font-size: 11px;
                                            color: #666;
                                            overflow: elide;
                                        }
                                    }

                                    VerticalLayout {
                                        alignment: center;
                                        width: 90px;
                                        spacing: 5px;

                                        Button {
                                            text: @tr("Edit");
                                            width: Styles.small_button_width;
                                            height: Styles.small_button_height;
                                            enabled: volume.loan-status != "Loaned" && volume.loan-status != "Overdue";
                                            clicked => {
                                                // Pre-fill edit form with current volume data
                                                root.edit-volume-id = volume.id;
                                                root.edit-volume-barcode = volume.barcode;
                                                root.edit-volume-condition = volume.condition;
                                                root.edit-volume-notes = volume.individual-notes;
                                                root.edit-volume-location-id = volume.location-id;

                                                // Find the location index for this location_id
                                                root.edit-volume-location-index = root.find-location-index(volume.location-id);

                                                root.show-volume-edit-dialog = true;
                                            }
                                        }

                                        Button {
                                            text: @tr("Delete");
                                            width: Styles.small_button_width;
                                            height: Styles.small_button_height;
                                            enabled: volume.loan-status != "Loaned" && volume.loan-status != "Overdue";
                                            clicked => {
                                                root.delete-volume-id = volume.id;
                                                root.delete-volume-barcode = volume.barcode;
                                                root.show-volume-delete-confirmation = true;
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
    }
}
