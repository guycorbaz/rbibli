// ============================================================================
// statistics_page.slint
// ============================================================================
// Statistics page for the rbibli personal library application.
//
// This page displays various statistics about the library, including:
// - Overall library counts (titles, volumes, authors, etc.)
// - Volumes per genre (bar chart visualization)
// - Volumes per location
// - Loan status breakdown
//
// All statistics are fetched from the backend API and displayed in an
// organized, easy-to-read format with visual indicators.
// ============================================================================

import { Page } from "page.slint";
import {
    ListView,
    VerticalBox,
    HorizontalBox,
    Button,
} from "std-widgets.slint";

// GenreStatistic - Volume and title count per genre
export struct GenreStatistic {
    genre-id: string,
    genre-name: string,
    volume-count: int,
    title-count: int,
}

// LocationStatistic - Volume count per location
export struct LocationStatistic {
    location-id: string,
    location-name: string,
    location-path: string,
    volume-count: int,
}

// LoanStatistic - Count per loan status
export struct LoanStatistic {
    status: string,
    count: int,
}

// LibraryStatistics - Overall library counts
export struct LibraryStatistics {
    total-titles: int,
    total-volumes: int,
    total-authors: int,
    total-publishers: int,
    total-genres: int,
    total-locations: int,
    total-borrowers: int,
    active-loans: int,
    overdue-loans: int,
}

export component StatisticsPage inherits Page {
    title: @tr("Statistics");
    description: @tr("View library statistics and analytics");

    // Properties
    in-out property <LibraryStatistics> library-stats: {
        total-titles: 0,
        total-volumes: 0,
        total-authors: 0,
        total-publishers: 0,
        total-genres: 0,
        total-locations: 0,
        total-borrowers: 0,
        active-loans: 0,
        overdue-loans: 0,
    };
    in-out property <[GenreStatistic]> genre-stats: [];
    in-out property <[LocationStatistic]> location-stats: [];
    in-out property <[LoanStatistic]> loan-stats: [];

    // Color palette for genre visualization
    property <[color]> colors: [
        #1976d2,
        #7b1fa2,
        #f57c00,
        #388e3c,
        #c62828,
        #0097a7,
        #5d4037,
        #fbc02d,
        #e91e63,
        #00796b,
        #303f9f,
        #c2185b,
        #689f38,
        #f57f17,
        #455a64
    ];

    // Callbacks
    callback load-statistics();

    VerticalBox {
        alignment: stretch;
        padding: 20px;
        spacing: 20px;

        // Header
        HorizontalBox {
            alignment: space-between;
            height: 50px;

            Text {
                text: @tr("Library Statistics");
                font-size: 24px;
                font-weight: 700;
            }

            Button {
                text: @tr("Refresh");
                min-width: 100px;
                height: 35px;
                clicked => {
                    root.load-statistics();
                }
            }
        }

        // Overall Library Statistics - Card Grid
        Text {
            text: @tr("Overview");
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        HorizontalBox {
            spacing: 15px;

            // Titles Card
            Rectangle {
                background: #e3f2fd;
                border-radius: 8px;
                border-width: 1px;
                border-color: #90caf9;

                VerticalBox {
                    padding: 15px;
                    alignment: center;
                    spacing: 8px;

                    Text {
                        text: library-stats.total-titles;
                        font-size: 32px;
                        font-weight: 700;
                        color: #1976d2;
                        horizontal-alignment: center;
                    }

                    Text {
                        text: @tr("Titles");
                        font-size: 13px;
                        color: #1565c0;
                        horizontal-alignment: center;
                    }
                }
            }

            // Volumes Card
            Rectangle {
                background: #f3e5f5;
                border-radius: 8px;
                border-width: 1px;
                border-color: #ce93d8;

                VerticalBox {
                    padding: 15px;
                    alignment: center;
                    spacing: 8px;

                    Text {
                        text: library-stats.total-volumes;
                        font-size: 32px;
                        font-weight: 700;
                        color: #7b1fa2;
                        horizontal-alignment: center;
                    }

                    Text {
                        text: @tr("Volumes");
                        font-size: 13px;
                        color: #6a1b9a;
                        horizontal-alignment: center;
                    }
                }
            }

            // Authors Card
            Rectangle {
                background: #fff3e0;
                border-radius: 8px;
                border-width: 1px;
                border-color: #ffb74d;

                VerticalBox {
                    padding: 15px;
                    alignment: center;
                    spacing: 8px;

                    Text {
                        text: library-stats.total-authors;
                        font-size: 32px;
                        font-weight: 700;
                        color: #f57c00;
                        horizontal-alignment: center;
                    }

                    Text {
                        text: @tr("Authors");
                        font-size: 13px;
                        color: #ef6c00;
                        horizontal-alignment: center;
                    }
                }
            }

            // Genres Card
            Rectangle {
                background: #e8f5e9;
                border-radius: 8px;
                border-width: 1px;
                border-color: #81c784;

                VerticalBox {
                    padding: 15px;
                    alignment: center;
                    spacing: 8px;

                    Text {
                        text: library-stats.total-genres;
                        font-size: 32px;
                        font-weight: 700;
                        color: #388e3c;
                        horizontal-alignment: center;
                    }

                    Text {
                        text: @tr("Genres");
                        font-size: 13px;
                        color: #2e7d32;
                        horizontal-alignment: center;
                    }
                }
            }
        }

        HorizontalBox {
            spacing: 15px;

            // Active Loans Card
            Rectangle {
                background: #fff8e1;
                border-radius: 8px;
                border-width: 1px;
                border-color: #ffd54f;

                VerticalBox {
                    padding: 15px;
                    alignment: center;
                    spacing: 8px;

                    Text {
                        text: library-stats.active-loans;
                        font-size: 32px;
                        font-weight: 700;
                        color: #f57f17;
                        horizontal-alignment: center;
                    }

                    Text {
                        text: @tr("Active Loans");
                        font-size: 13px;
                        color: #f57f17;
                        horizontal-alignment: center;
                    }
                }
            }

            // Overdue Loans Card
            Rectangle {
                background: library-stats.overdue-loans > 0 ? #ffebee : #f5f5f5;
                border-radius: 8px;
                border-width: 1px;
                border-color: library-stats.overdue-loans > 0 ? #e57373 : #ccc;

                VerticalBox {
                    padding: 15px;
                    alignment: center;
                    spacing: 8px;

                    Text {
                        text: library-stats.overdue-loans;
                        font-size: 32px;
                        font-weight: 700;
                        color: library-stats.overdue-loans > 0 ? #c62828 : #666;
                        horizontal-alignment: center;
                    }

                    Text {
                        text: @tr("Overdue");
                        font-size: 13px;
                        color: library-stats.overdue-loans > 0 ? #b71c1c : #666;
                        horizontal-alignment: center;
                    }
                }
            }

            // Borrowers Card
            Rectangle {
                background: #fce4ec;
                border-radius: 8px;
                border-width: 1px;
                border-color: #f48fb1;

                VerticalBox {
                    padding: 15px;
                    alignment: center;
                    spacing: 8px;

                    Text {
                        text: library-stats.total-borrowers;
                        font-size: 32px;
                        font-weight: 700;
                        color: #c2185b;
                        horizontal-alignment: center;
                    }

                    Text {
                        text: @tr("Borrowers");
                        font-size: 13px;
                        color: #ad1457;
                        horizontal-alignment: center;
                    }
                }
            }

            // Locations Card
            Rectangle {
                background: #e0f2f1;
                border-radius: 8px;
                border-width: 1px;
                border-color: #80cbc4;

                VerticalBox {
                    padding: 15px;
                    alignment: center;
                    spacing: 8px;

                    Text {
                        text: library-stats.total-locations;
                        font-size: 32px;
                        font-weight: 700;
                        color: #00796b;
                        horizontal-alignment: center;
                    }

                    Text {
                        text: @tr("Locations");
                        font-size: 13px;
                        color: #00695c;
                        horizontal-alignment: center;
                    }
                }
            }
        }

        // Volumes per Genre Section
        Text {
            text: @tr("Volumes per Genre");
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        if genre-stats.length == 0: Text {
            text: @tr("No genre statistics available. Click Refresh to load data.");
            color: #888;
            font-size: 14px;
        }

        if genre-stats.length > 0: Rectangle {
            background: white;
            border-width: 1px;
            border-color: #ddd;
            border-radius: 8px;
            min-height: 450px;

            HorizontalBox {
                padding: 20px;
                spacing: 40px;

                // Pie Chart Container
                Rectangle {
                    width: 350px;
                    height: 350px;

                    // Helper properties for pie chart calculations
                    property <float> center-x: 175.0;
                    property <float> center-y: 175.0;
                    property <float> radius: 135.0;
                    property <int> total: Math.max(1, root.library-stats.total-volumes);

                    // Pre-calculate values to ensure stable rendering
                    property <int> v0: genre-stats.length > 0 ? genre-stats[0].volume-count : 0;
                    property <int> v1: genre-stats.length > 1 ? genre-stats[1].volume-count : 0;
                    property <int> v2: genre-stats.length > 2 ? genre-stats[2].volume-count : 0;
                    property <int> v3: genre-stats.length > 3 ? genre-stats[3].volume-count : 0;
                    property <int> v4: genre-stats.length > 4 ? genre-stats[4].volume-count : 0;

                    property <int> acc0: 0;
                    property <int> acc1: v0;
                    property <int> acc2: v0 + v1;
                    property <int> acc3: v0 + v1 + v2;
                    property <int> acc4: v0 + v1 + v2 + v3;

                    // Draw pie slices for each genre (up to 5 genres shown)
                    if v0 > 0: Path {
                        width: 100%;
                        height: 100%;
                        property <float> val: v0;
                        property <float> start-val: acc0;
                        property <float> angle: 360.0 * val / total;
                        property <float> start-angle: 360.0 * start-val / total;
                        property <float> end-angle: start-angle + angle;

                        commands: angle > 0.1 ? ("M " + center-x + " " + center-y + " L " + (center-x + radius * Math.cos((start-angle - 90) * 1deg)) + " " + (center-y + radius * Math.sin((start-angle - 90) * 1deg)) + " A " + radius + " " + radius + " 0 " + (angle > 180.0 ? "1" : "0") + " 1 " + (center-x + radius * Math.cos((end-angle - 90) * 1deg)) + " " + (center-y + radius * Math.sin((end-angle - 90) * 1deg)) + " Z M 0 0 M 350 350") : "";
                        fill: root.colors[0];
                        stroke: white;
                        stroke-width: 2px;
                    }

                    if v1 > 0: Path {
                        width: 100%;
                        height: 100%;
                        property <float> val: v1;
                        property <float> start-val: acc1;
                        property <float> angle: 360.0 * val / total;
                        property <float> start-angle: 360.0 * start-val / total;
                        property <float> end-angle: start-angle + angle;

                        commands: angle > 0.1 ? ("M " + center-x + " " + center-y + " L " + (center-x + radius * Math.cos((start-angle - 90) * 1deg)) + " " + (center-y + radius * Math.sin((start-angle - 90) * 1deg)) + " A " + radius + " " + radius + " 0 " + (angle > 180.0 ? "1" : "0") + " 1 " + (center-x + radius * Math.cos((end-angle - 90) * 1deg)) + " " + (center-y + radius * Math.sin((end-angle - 90) * 1deg)) + " Z M 0 0 M 350 350") : "";
                        fill: root.colors[1];
                        stroke: white;
                        stroke-width: 2px;
                    }

                    if v2 > 0: Path {
                        width: 100%;
                        height: 100%;
                        property <float> val: v2;
                        property <float> start-val: acc2;
                        property <float> angle: 360.0 * val / total;
                        property <float> start-angle: 360.0 * start-val / total;
                        property <float> end-angle: start-angle + angle;

                        commands: angle > 0.1 ? ("M " + center-x + " " + center-y + " L " + (center-x + radius * Math.cos((start-angle - 90) * 1deg)) + " " + (center-y + radius * Math.sin((start-angle - 90) * 1deg)) + " A " + radius + " " + radius + " 0 " + (angle > 180.0 ? "1" : "0") + " 1 " + (center-x + radius * Math.cos((end-angle - 90) * 1deg)) + " " + (center-y + radius * Math.sin((end-angle - 90) * 1deg)) + " Z M 0 0 M 350 350") : "";
                        fill: root.colors[2];
                        stroke: white;
                        stroke-width: 2px;
                    }

                    if v3 > 0: Path {
                        width: 100%;
                        height: 100%;
                        property <float> val: v3;
                        property <float> start-val: acc3;
                        property <float> angle: 360.0 * val / total;
                        property <float> start-angle: 360.0 * start-val / total;
                        property <float> end-angle: start-angle + angle;

                        commands: angle > 0.1 ? ("M " + center-x + " " + center-y + " L " + (center-x + radius * Math.cos((start-angle - 90) * 1deg)) + " " + (center-y + radius * Math.sin((start-angle - 90) * 1deg)) + " A " + radius + " " + radius + " 0 " + (angle > 180.0 ? "1" : "0") + " 1 " + (center-x + radius * Math.cos((end-angle - 90) * 1deg)) + " " + (center-y + radius * Math.sin((end-angle - 90) * 1deg)) + " Z M 0 0 M 350 350") : "";
                        fill: root.colors[3];
                        stroke: white;
                        stroke-width: 2px;
                    }

                    if v4 > 0: Path {
                        width: 100%;
                        height: 100%;
                        property <float> val: v4;
                        property <float> start-val: acc4;
                        property <float> angle: 360.0 * val / total;
                        property <float> start-angle: 360.0 * start-val / total;
                        property <float> end-angle: start-angle + angle;

                        commands: angle > 0.1 ? ("M " + center-x + " " + center-y + " L " + (center-x + radius * Math.cos((start-angle - 90) * 1deg)) + " " + (center-y + radius * Math.sin((start-angle - 90) * 1deg)) + " A " + radius + " " + radius + " 0 " + (angle > 180.0 ? "1" : "0") + " 1 " + (center-x + radius * Math.cos((end-angle - 90) * 1deg)) + " " + (center-y + radius * Math.sin((end-angle - 90) * 1deg)) + " Z M 0 0 M 350 350") : "";
                        fill: root.colors[4];
                        stroke: white;
                        stroke-width: 2px;
                    }

                    // Center circle for donut effect
                    Rectangle {
                        x: 85px;
                        y: 85px;
                        width: 180px;
                        height: 180px;
                        border-radius: 90px;
                        background: white;

                        VerticalBox {
                            alignment: center;

                            Text {
                                text: total;
                                font-size: 42px;
                                font-weight: 700;
                                color: #333;
                                horizontal-alignment: center;
                            }

                            Text {
                                text: @tr("Total Volumes");
                                font-size: 13px;
                                color: #666;
                                horizontal-alignment: center;
                            }
                        }
                    }
                }

                // Legend
                VerticalBox {
                    spacing: 10px;
                    // alignment: start; // Allow stretching to fill height

                    Text {
                        text: @tr("Legend");
                        font-size: 16px;
                        font-weight: 600;
                        color: #333;
                    }

                    ListView {
                        min-height: 500px; // Force larger vertical area for legend items
                        for stat[index] in genre-stats: HorizontalBox {
                            height: 32px;
                            spacing: 12px;

                            // Color box
                            Rectangle {
                                width: 24px;
                                height: 24px;
                                border-radius: 4px;
                                background: root.colors[Math.mod(index, root.colors.length)];
                            }

                            // Genre info
                            VerticalBox {
                                spacing: 2px;
                                alignment: center;

                                Text {
                                    text: stat.genre-name;
                                    font-size: 14px;
                                    font-weight: 600;
                                    overflow: elide;
                                }

                                Text {
                                    text: stat.volume-count + " " + @tr("volumes") + " (" + Math.round(100.0 * stat.volume-count / Math.max(1, root.library-stats.total-volumes)) + "%)";
                                    font-size: 11px;
                                    color: #666;
                                }
                            }
                        }
                    }
                }
            }
        }

        // Volumes per Location Section
        Text {
            text: @tr("Volumes per Location");
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        if location-stats.length == 0: Text {
            text: @tr("No location statistics available.");
            color: #888;
            font-size: 14px;
        }

        if location-stats.length > 0: Rectangle {
            background: white;
            border-width: 1px;
            border-color: #ddd;
            border-radius: 8px;

            ListView {
                min-height: 300px; // Force list to expand to show all locations
                for stat[index] in location-stats: Rectangle {
                    height: 50px;
                    border-width: 1px;
                    border-color: #eee;
                    background: Math.mod(index, 2) == 0 ? #fafafa : white;

                    HorizontalLayout {
                        padding: 15px;
                        spacing: 15px;

                        Text {
                            text: stat.location-path;
                            font-size: 13px;
                            color: #444;
                            overflow: elide;
                            horizontal-stretch: 1;
                            vertical-alignment: center;
                        }

                        Text {
                            text: stat.volume-count + " " + @tr("volumes");
                            font-size: 14px;
                            font-weight: 700;
                            color: #00796b;
                            width: 100px;
                            horizontal-alignment: right;
                            vertical-alignment: center;
                        }
                    }
                }
            }
        }
    }
}
